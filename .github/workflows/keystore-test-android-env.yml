name: Configure Android Keystore for E2E Tests

on:
  push:

permissions:
  contents: write
  id-token: write

jobs:
  ios-e2e:
    runs-on: ubuntu-latest
    env:
      GITHUB_CI: "true"
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Keystores for iOS E2E Tests
        uses: MetaMask/github-tools/.github/actions/configure-keystore@e2e-env-actions-keystore
        with:
          aws-role-to-assume: 'arn:aws:iam::722264665990:role/metamask-mobile-build-signing-certificate-manager'
          aws-region: 'us-east-2'
          platform: 'android'
          environment: 'qa'

      - name: Check keystore file and entry count
        shell: bash
        run: |
          echo "📁 Keystore path: ${ANDROID_KEYSTORE_PATH}"

          if [[ -z "$ANDROID_KEYSTORE_PATH" ]]; then
            echo "❌ ANDROID_KEYSTORE_PATH is not set"
            exit 1
          fi

          if [[ ! -e "$ANDROID_KEYSTORE_PATH" ]]; then
            echo "❌ Keystore file does not exist at path: $ANDROID_KEYSTORE_PATH"
            exit 1
          fi

          if [[ ! -s "$ANDROID_KEYSTORE_PATH" ]]; then
            echo "❌ Keystore file is empty: $ANDROID_KEYSTORE_PATH"
            ls -lh "$ANDROID_KEYSTORE_PATH"
            exit 1
          fi

          echo "📦 Keystore file found:"
          ls -lh "$ANDROID_KEYSTORE_PATH"

          echo "🔐 Validating keystore..."
          alias_count=$(keytool -list \
            -keystore "$ANDROID_KEYSTORE_PATH" \
            -storepass "$BITRISEIO_ANDROID_QA_KEYSTORE_PASSWORD" \
            2>&1 | tee /dev/stderr | grep -c "Alias name") || {
              echo "❌ keytool failed during validation"
              exit 1
            }

          echo "✅ Keystore entry count: $alias_count"



