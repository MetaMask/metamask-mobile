name: Configure Android Keystore for E2E Tests

on:
  push:

permissions:
  contents: write
  id-token: write

jobs:
  ios-e2e:
    runs-on: ubuntu-latest
    env:
      GITHUB_CI: "true"
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Keystores for iOS E2E Tests
        uses: MetaMask/github-tools/.github/actions/configure-keystore@e2e-env-actions-keystore
        with:
          aws-role-to-assume: 'arn:aws:iam::722264665990:role/metamask-mobile-build-signing-certificate-manager'
          aws-region: 'us-east-2'
          platform: 'android'
          environment: 'qa'

      - name: Check keystore file and entry count
        shell: bash
        run: |
          echo "üìÅ Keystore path: ${ANDROID_KEYSTORE_PATH}"

          if [[ -z "$ANDROID_KEYSTORE_PATH" ]]; then
            echo "‚ùå ANDROID_KEYSTORE_PATH is not set"
            exit 1
          fi

          if [[ ! -e "$ANDROID_KEYSTORE_PATH" ]]; then
            echo "‚ùå Keystore file does not exist at path: $ANDROID_KEYSTORE_PATH"
            exit 1
          fi

          if [[ ! -s "$ANDROID_KEYSTORE_PATH" ]]; then
            echo "‚ùå Keystore file is empty: $ANDROID_KEYSTORE_PATH"
            ls -lh "$ANDROID_KEYSTORE_PATH"
            exit 1
          fi

          echo "üì¶ Keystore file found:"
          ls -lh "$ANDROID_KEYSTORE_PATH"

          echo "üîê Validating keystore..."
          keytool_output=$(keytool -list \
            -keystore "$ANDROID_KEYSTORE_PATH" \
            -storepass "$BITRISEIO_ANDROID_QA_KEYSTORE_PASSWORD" \
            2>&1)

          echo "$keytool_output"

          # Count "PrivateKeyEntry" lines (more reliable than "Alias name" in some formats)
          alias_count=$(echo "$keytool_output" | grep -c "PrivateKeyEntry")

          if [[ "$alias_count" -eq 0 ]]; then
            echo "‚ö†Ô∏è No PrivateKeyEntry found in keystore. Contents may be unexpected."
          fi

          echo "‚úÖ Keystore entry count: $alias_count"




