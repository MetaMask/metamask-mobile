# This workflow is used to detect changes in the Android and iOS projects.
# It can be used to determine if the build should be triggered for the Android and iOS projects.
# Outputs:
# - android_changed: Whether Android-impacting files changed
# - ios_changed: Whether iOS-impacting files changed
# - any_changed: Whether either platform requires a build

name: Detect Mobile Build Changes

on:
  workflow_call:
    outputs:
      android_changed:
        description: 'Whether Android-impacting files changed'
        value: ${{ jobs.detect.outputs.android }}
      ios_changed:
        description: 'Whether iOS-impacting files changed'
        value: ${{ jobs.detect.outputs.ios }}

jobs:
  detect:
    name: Detect platform changes (Android/iOS)
    runs-on: ubuntu-latest
    outputs:
      android: ${{ steps.set-outputs.outputs.android_final }}
      ios: ${{ steps.set-outputs.outputs.ios_final }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Paths filter (Android/iOS impact)
        id: filter
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36
        with:
          filters: |
            android:
              - '!**/*.ios.*'                      # Exclude iOS file extensions from Android
              - '!app/**/ios/**'                   # Exclude iOS-specific from Android
              - 'android/**'                       # All Android project files
              - 'android/app/build.gradle'         # Gradle build files
              - 'android/gradlew'                  # Gradle wrapper
              - 'android/settings.gradle'          # Gradle settings
              - 'app/**/android/**'                # Android-specific app code
              - 'core/**/android/**'               # Android-specific core modules
              - 'app/configs/android/**'           # Android configs
              - 'app/constants/android/**'         # Android constants
              - 'app/components/**/android/**'     # Android UI components
              - 'app/util/**/android/**'           # Android utilities
              - '**/*.android.*'                   # Android-specific file extensions (e.g., .android.tsx)
              - 'package.json'                     # If native deps change
              - 'metro.config.js'                  # Metro bundler affects both
              - 'tsconfig.json'                    # TypeScript config affects both
              - 'babel.config.js'                  # Transpilation affects both
              - 'yarn.lock'                        # Dependency changes affect both
              - 'app/**'                           # Shared app files affect both
              

            ios:
              - '!**/*.android.*'                  # Exclude Android file extensions from iOS
              - '!app/**/android/**'               # Exclude Android-specific from iOS
              - 'ios/**'                           # All iOS project files
              - 'Podfile'                          # CocoaPods dependencies
              - 'Podfile.lock'                     # Pod lockfile
              - '**/*.xcodeproj/**'                # Xcode project files
              - '**/*.xcworkspace/**'              # Xcode workspace
              - 'app/**/ios/**'                    # iOS-specific app code
              - 'core/**/ios/**'                   # iOS-specific core modules
              - 'app/configs/ios/**'               # iOS configs
              - 'app/constants/ios/**'             # iOS constants
              - 'app/components/**/ios/**'         # iOS UI components
              - 'app/util/**/ios/**'               # iOS utilities
              - '**/*.ios.*'                       # iOS-specific file extensions (e.g., .ios.tsx)
              - 'package.json'                     # If native deps change
              - 'metro.config.js'                  # Metro bundler affects both
              - 'tsconfig.json'                    # TypeScript config affects both
              - 'babel.config.js'                  # Transpilation affects both
              - 'yarn.lock'                        # Dependency changes affects both
              - 'app/**'                           # Shared app files affect both

            docs_only:
                - '**/*.md'                           # Documentation files
                - 'docs/**'                           # Documentation directory
                - '**/*.yml'                          # Workflow files  
                - '.github/**'                        # GitHub workflow changes

      - name: Set final outputs
        id: set-outputs
        run: |
          # Check if ONLY docs/workflows changed (no code changes)
          android_result="${{ steps.filter.outputs.android }}"
          ios_result="${{ steps.filter.outputs.ios }}"
          docs_only="${{ steps.filter.outputs.docs_only }}"
          
          # Skip builds only if docs/workflows changed AND no mobile code changed
          if [[ "$docs_only" == 'true' && "$android_result" == 'false' && "$ios_result" == 'false' ]]; then
            echo "Skipping all mobile builds - changes only affect docs/workflows, no mobile code changed"
            echo "android_final=false" >> "${GITHUB_OUTPUT}"
            echo "ios_final=false" >> "${GITHUB_OUTPUT}"
          else
            echo "Mobile build decisions:"
            echo "  Android: $android_result"
            echo "  iOS: $ios_result"
            
            echo "android_final=$android_result" >> "${GITHUB_OUTPUT}"
            echo "ios_final=$ios_result" >> "${GITHUB_OUTPUT}"
          fi
          
      - name: Summary
        run: |
          {
            echo "Android changed: ${{ steps.set-outputs.outputs.android_final }}"
            echo "iOS changed: ${{ steps.set-outputs.outputs.ios_final }}"
          } >> "${GITHUB_STEP_SUMMARY}"
