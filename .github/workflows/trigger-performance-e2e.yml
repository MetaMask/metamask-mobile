name: Performance E2E Test Manual WorkFlow
on:
  schedule:
    - cron: '0 3 * * 1-6'
  workflow_dispatch:
    inputs:
      description:
        description: 'Optional description for this test run'
        required: false
        type: string
      browserstack_app_url_android:
        description: 'BrowserStack Android App URL (bs://...)'
        required: false
        type: string
      browserstack_app_url_ios:
        description: 'BrowserStack iOS App URL (bs://...)'
        required: false
        type: string

permissions:
  contents: read
  id-token: write

env:
  BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
  BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
  MM_TEST_ACCOUNT_SRP: ${{ secrets.MM_TEST_ACCOUNT_SRP }}
  TEST_SRP_1: ${{ secrets.TEST_SRP_1 }}
  TEST_SRP_2: ${{ secrets.TEST_SRP_2 }}
  TEST_SRP_3: ${{ secrets.TEST_SRP_3 }}
  E2E_PASSWORD: ${{ secrets.E2E_PASSWORD }}
  DISABLE_VIDEO_DOWNLOAD: true

jobs:
  # =============================================================================
  # SETUP AND BUILD JOBS
  # =============================================================================
  
  read-device-matrix:
    name: Read Device Matrix
    runs-on: ubuntu-latest
    outputs:
      android_matrix: ${{ steps.matrix.outputs.android }}
      ios_matrix: ${{ steps.matrix.outputs.ios }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Read device matrix
        id: matrix
        run: |
          echo "Reading device matrix from appwright/device-matrix.json"
          
          ANDROID_MATRIX=$(jq -r ".android_devices | map({name: .name, os_version: .os_version, category: .category}) | tojson" appwright/device-matrix.json)
          IOS_MATRIX=$(jq -r ".ios_devices | map({name: .name, os_version: .os_version, category: .category}) | tojson" appwright/device-matrix.json)
          
          {
            echo "android=$ANDROID_MATRIX"
            echo "ios=$IOS_MATRIX"
          } >> "$GITHUB_OUTPUT"
          
          echo "Android matrix: $ANDROID_MATRIX"
          echo "iOS matrix: $IOS_MATRIX"
          
          ANDROID_COUNT=$(echo "$ANDROID_MATRIX" | jq 'length')
          IOS_COUNT=$(echo "$IOS_MATRIX" | jq 'length')
          
          echo "Found $ANDROID_COUNT Android devices and $IOS_COUNT iOS devices"
          
          if [ "$ANDROID_COUNT" -eq 0 ] && [ "$IOS_COUNT" -eq 0 ]; then
            echo "Error: No devices found in device-matrix.json"
            exit 1
          fi

  trigger-android-dual-versions:
    name: Trigger Android Dual Versions and Extract BrowserStack URLs
    uses: ./.github/workflows/build-android-upload-to-browserstack.yml
    if: ${{ !inputs.browserstack_app_url_android || !inputs.browserstack_app_url_ios }}
    secrets: inherit

  trigger-ios-dual-versions:
    name: Trigger iOS Dual Versions and Extract BrowserStack URLs
    uses: ./.github/workflows/build-ios-upload-to-browserstack.yml.yml
    if: ${{ !inputs.browserstack_app_url_android || !inputs.browserstack_app_url_ios }}
    secrets: inherit

  # =============================================================================
  # PERFORMANCE TEST EXECUTION (Reusable Job Template)
  # =============================================================================
  
  run-performance-tests:
    name: Run ${{ matrix.test_scenario }} Tests on ${{ matrix.platform }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: [read-device-matrix, trigger-android-dual-versions, trigger-ios-dual-versions]
    if: always() && !failure() && !cancelled()
    strategy:
      fail-fast: false
      matrix:
        include:
          # Imported Wallet Tests
          - test_scenario: imported-wallet
            platform: android
            device_matrix: ${{ needs.read-device-matrix.outputs.android_matrix }}
            browserstack_app_url: ${{ needs.trigger-android-dual-versions.outputs.with-srp-browserstack-url || inputs.browserstack_app_url_android }}
            app_version: ${{ needs.trigger-android-dual-versions.outputs.with-srp-version || 'Manual-Input' }}
            build_name_suffix: Performance
          - test_scenario: imported-wallet
            platform: ios
            device_matrix: ${{ needs.read-device-matrix.outputs.ios_matrix }}
            browserstack_app_url: ${{ needs.trigger-ios-dual-versions.outputs.with-srp-browserstack-url || inputs.browserstack_app_url_ios }}
            app_version: ${{ needs.trigger-ios-dual-versions.outputs.with-srp-version || 'Manual-Input' }}
            build_name_suffix: Performance
          # Onboarding Tests
          - test_scenario: onboarding
            platform: android
            device_matrix: ${{ needs.read-device-matrix.outputs.android_matrix }}
            browserstack_app_url: ${{ needs.trigger-android-dual-versions.outputs.without-srp-browserstack-url || inputs.browserstack_app_url_android }}
            app_version: ${{ needs.trigger-android-dual-versions.outputs.without-srp-version || 'Manual-Input' }}
            build_name_suffix: Onboarding
          - test_scenario: onboarding
            platform: ios
            device_matrix: ${{ needs.read-device-matrix.outputs.ios_matrix }}
            browserstack_app_url: ${{ needs.trigger-ios-dual-versions.outputs.without-srp-browserstack-url || inputs.browserstack_app_url_ios }}
            app_version: ${{ needs.trigger-ios-dual-versions.outputs.without-srp-version || 'Manual-Input' }}
            build_name_suffix: Onboarding
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Restore node_modules cache
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            .yarn/cache
            .yarn/install-state.gz
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'yarn'
      
      - name: Install dependencies (if cache miss)
        if: steps.cache.outputs.cache-hit != 'true'
        run: yarn setup
      
      - name: BrowserStack Env Setup
        uses: browserstack/github-actions/setup-env@4478e16186f38e5be07721931642e65a028713c3
        with:
          username: ${{ env.BROWSERSTACK_USERNAME }}
          access-key: ${{ env.BROWSERSTACK_ACCESS_KEY }}
          project-name: ${{ github.repository }}
      
      - name: Setup BrowserStack Local
        uses: browserstack/github-actions/setup-local@4478e16186f38e5be07721931642e65a028713c3
        with:
          local-testing: start
          local-identifier: ${{ github.run_id }}
          local-args: --force-local --verbose
      
      - name: Wait for BrowserStack Local
        run: |
          echo "Waiting for BrowserStack Local to be ready..."
          sleep 30
          echo "BrowserStack Local should be ready now"
      
      - name: Set Test Environment
        run: |
          echo "Setting ${{ matrix.test_scenario }} test environment for platform: ${{ matrix.platform }}"
          
          # Validate that we have a BrowserStack URL
          if [ -z "${{ matrix.browserstack_app_url }}" ]; then
            echo "‚ùå Error: No ${{ matrix.platform }} BrowserStack URL available"
            exit 1
          fi
          
          # Set platform-specific environment variables
          if [ "${{ matrix.platform }}" = "android" ]; then
            APP_URL_VAR="BROWSERSTACK_ANDROID_APP_URL"
            CLEAN_APP_URL_VAR="BROWSERSTACK_ANDROID_CLEAN_APP_URL"
            TEST_PLATFORM="android"
          else
            APP_URL_VAR="BROWSERSTACK_IOS_APP_URL"
            CLEAN_APP_URL_VAR="BROWSERSTACK_IOS_CLEAN_APP_URL"
            TEST_PLATFORM="ios"
          fi
          
          # Set the appropriate URL variable based on test scenario
          if [ "${{ matrix.test_scenario }}" = "onboarding" ]; then
            URL_VAR="$CLEAN_APP_URL_VAR"
          else
            URL_VAR="$APP_URL_VAR"
          fi
          
          {
            echo "BROWSERSTACK_DEVICE=${{ matrix.device.name }}"
            echo "BROWSERSTACK_OS_VERSION=${{ matrix.device.os_version }}"
            echo "$URL_VAR=${{ matrix.browserstack_app_url }}"
            echo "TEST_PLATFORM=$TEST_PLATFORM"
            echo "QA_APP_VERSION=${{ matrix.app_version }}"
            echo "BROWSERSTACK_BUILD_NAME=${{ matrix.platform }}-${{ matrix.build_name_suffix }}-${{ github.ref_name }}-Branch"
          } >> "$GITHUB_ENV"
      
      - name: Run Performance Tests
        env:
          BROWSERSTACK_LOCAL: true
          BROWSERSTACK_LOCAL_IDENTIFIER: ${{ github.run_id }}
        run: |
          echo "=== Testing ${{ matrix.test_scenario }} on ${{ matrix.platform }} ==="
          echo "BrowserStack App URL: ${{ matrix.browserstack_app_url }}"
          echo "QA App Version: ${{ matrix.app_version }}"
          
          # Run the appropriate test command based on platform and scenario
          if [ "${{ matrix.platform }}" = "android" ]; then
            if [ "${{ matrix.test_scenario }}" = "onboarding" ]; then
              yarn run-appwright:android-onboarding-bs
            else
              yarn run-appwright:android-bs
            fi
          else
            if [ "${{ matrix.platform }}" = "ios" ] && ([ "${{ matrix.device.os_version }}" = "13" ] || [ "${{ matrix.device.os_version }}" = "11" ]); then
              echo "Warning: iOS ${{ matrix.device.os_version }} may not be supported by MetaMask app"
            fi
            
            if [ "${{ matrix.test_scenario }}" = "onboarding" ]; then
              yarn run-appwright:ios-onboarding-bs
            else
              yarn run-appwright:ios-bs
            fi
          fi
      
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ${{ matrix.platform }}-${{ matrix.test_scenario }}-test-results-${{ matrix.device.name }}-${{ matrix.device.os_version }}
          path: |
            appwright/test-reports/appwright-report/
            appwright/reporters/reports
          if-no-files-found: ignore
          retention-days: 7

  # =============================================================================
  # RESULTS AGGREGATION
  # =============================================================================
  
  aggregate-results:
    name: Aggregate All Test Results
    runs-on: ubuntu-latest
    needs: [run-performance-tests]
    if: always()
    
    steps:
      - name: Download All Test Results
        uses: actions/download-artifact@v4
        with:
          pattern: '*-test-results-*'
          merge-multiple: true
          path: ./all-results
        continue-on-error: true
      
      - name: Process and Aggregate Results
        run: |
          echo "Processing all test results..."
          
          # Create output directory
          mkdir -p appwright/aggregated-reports
          
          # Run the aggregation script
          echo "üîÑ Running aggregation script..."
          node scripts/aggregate-performance-reports.mjs || {
            echo "‚ö†Ô∏è Aggregation script had issues, but continuing"
          }
          
          # List generated files
          echo "üìÅ Generated files:"
          ls -la appwright/aggregated-reports/ || echo "üìÅ No aggregated reports directory found"
      
      - name: Upload Final Combined Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: final-combined-performance-results
          path: |
            appwright/aggregated-reports/
            appwright/test-reports/appwright-report/
            appwright/reporters/reports
          if-no-files-found: ignore
          retention-days: 14

  # =============================================================================
  # SLACK NOTIFICATION
  # =============================================================================
  
  slack-notification:
    name: Send Slack Notification
    runs-on: ubuntu-latest
    needs: [aggregate-results, read-device-matrix]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Generate Test Summary
        id: test-summary
        run: |
          echo "Generating test summary..."
          
          # Get device matrix for device names
          DEVICE_MATRIX=$(cat appwright/device-matrix.json)
          
          # Extract device information from device matrix
          ANDROID_DEVICES=$(echo "$DEVICE_MATRIX" | jq -r '.android_devices[] | "\(.name) (\(.os_version))"')
          IOS_DEVICES=$(echo "$DEVICE_MATRIX" | jq -r '.ios_devices[] | "\(.name) (\(.os_version))"')
          
          # Count total devices tested
          ANDROID_COUNT=$(echo "$ANDROID_DEVICES" | wc -l)
          IOS_COUNT=$(echo "$IOS_DEVICES" | wc -l)
          TOTAL_DEVICES=$((ANDROID_COUNT + IOS_COUNT))
          
          # Get status from aggregate-results job
          AGGREGATE_STATUS="${{ needs.aggregate-results.result }}"
          
          # Create summary
          SUMMARY="*Performance E2E Tests (Consolidated)*\n\n"
          
          SUMMARY+="---------------\n\n"
          SUMMARY+="*Devices Tested (${TOTAL_DEVICES} total):*\n"
          SUMMARY+="‚Ä¢ Android (${ANDROID_COUNT} devices):\n"
          while IFS= read -r device; do
            if [ -n "$device" ]; then
              SUMMARY+="  ‚Ä¢ $device\n"
            fi
          done <<< "$ANDROID_DEVICES"
          SUMMARY+="‚Ä¢ iOS (${IOS_COUNT} devices):\n"
          while IFS= read -r device; do
            if [ -n "$device" ]; then
              SUMMARY+="  ‚Ä¢ $device\n"
            fi
          done <<< "$IOS_DEVICES"
          SUMMARY+="\n"
          SUMMARY+="---------------\n\n"
          SUMMARY+="*Test Results:*\n"
          SUMMARY+="‚Ä¢ Overall Status: $AGGREGATE_STATUS\n\n"
          SUMMARY+="---------------\n\n"
          SUMMARY+="*Build Info:*\n"
          SUMMARY+="‚Ä¢ Commit Hash: \`${{ github.sha }}\`\n"
          SUMMARY+="‚Ä¢ Branch: \`${{ github.ref_name }}\`\n"
          SUMMARY+="---------------\n\n"
          SUMMARY+="<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Full Results>"
          
          {
            echo "summary<<EOF"
            echo "$SUMMARY"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
          
          echo "Test summary generated"
      
      - name: Send Slack Notification
        uses: slackapi/slack-github-action@91efab103c0de0a537f72a35f6b8cda0ee76bf0a
        with:
          webhook: ${{ secrets.PERFORMANCE_E2E_SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "${{ steps.test-summary.outputs.summary }}"
            }
