# This workflow orchestrates mobile E2E smoke tests with separate jobs per category.
# Each category job runs all tests for that category on the specified platform.

name: Mobile E2E Smoke Tests

on:
  workflow_call:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: write
  id-token: write

jobs:
  # Build Android APKs once for all Android tests
  build-android-apks:
    name: "Build Android APKs (Shared)"
    uses: ./.github/workflows/build-android-e2e.yml
    secrets: inherit

  smoke-confirmations-ios:
    name: "Confirmations Smoke (iOS) - Part ${{ matrix.split }}"
    if: false
    strategy:
      matrix:
        split: [1, 2]
      fail-fast: false
    uses: ./.github/workflows/run-e2e-workflow.yml
    with:
      test-suite-name: smoke-confirmations-ios-part${{ matrix.split }}
      platform: ios
      test_suite_tag: ".*SmokeConfirmations.*"
      split_number: ${{ matrix.split }}
      total_splits: 2
    secrets: inherit

  smoke-confirmations-android:
    name: "Confirmations Smoke (Android) - Part ${{ matrix.split }}"
    needs: build-android-apks
    if: always() && needs.build-android-apks.result != 'failure'
    strategy:
      matrix:
        split: [1, 2]
      fail-fast: false
    uses: ./.github/workflows/run-e2e-workflow.yml
    with:
      test-suite-name: smoke-confirmations-android-part${{ matrix.split }}
      platform: android
      test_suite_tag: ".*SmokeConfirmations.*"
      split_number: ${{ matrix.split }}
      total_splits: 2
    secrets: inherit

  smoke-confirmations-redesigned-ios:
    name: "Confirmations Redesigned Smoke (iOS) - Part ${{ matrix.split }}"
    if: false
    strategy:
      matrix:
        split: [1, 2]
      fail-fast: false
    uses: ./.github/workflows/run-e2e-workflow.yml
    with:
      test-suite-name: smoke-confirmations-redesigned-ios-part${{ matrix.split }}
      platform: ios
      test_suite_tag: ".*SmokeConfirmationsRedesigned.*"
      split_number: ${{ matrix.split }}
      total_splits: 2
    secrets: inherit

  smoke-trade-ios:
    name: "Trade Smoke (iOS) - Part ${{ matrix.split }}"
    if: false
    strategy:
      matrix:
        split: [1, 2]
      fail-fast: false
    uses: ./.github/workflows/run-e2e-workflow.yml
    with:
      test-suite-name: smoke-trade-ios-part${{ matrix.split }}
      platform: ios
      test_suite_tag: ".*SmokeTrade.*"
      split_number: ${{ matrix.split }}
      total_splits: 2
    secrets: inherit

  smoke-trade-android:
    name: "Trade Smoke (Android) - Part ${{ matrix.split }}"
    needs: build-android-apks
    if: always() && needs.build-android-apks.result != 'failure'
    strategy:
      matrix:
        split: [1, 2]
      fail-fast: false
    uses: ./.github/workflows/run-e2e-workflow.yml
    with:
      test-suite-name: smoke-trade-android-part${{ matrix.split }}
      platform: android
      test_suite_tag: ".*SmokeTrade.*"
      split_number: ${{ matrix.split }}
      total_splits: 2
    secrets: inherit

  smoke-wallet-platform-ios:
    name: "Wallet Platform Smoke (iOS) - Part ${{ matrix.split }}"
    if: false
    strategy:
      matrix:
        split: [1, 2]
      fail-fast: false
    uses: ./.github/workflows/run-e2e-workflow.yml
    with:
      test-suite-name: smoke-wallet-platform-ios-part${{ matrix.split }}
      platform: ios
      test_suite_tag: ".*SmokeWalletPlatform.*"
      split_number: ${{ matrix.split }}
      total_splits: 2
    secrets: inherit

  smoke-wallet-platform-android:
    name: "Wallet Platform Smoke (Android) - Part ${{ matrix.split }}"
    needs: build-android-apks
    if: always() && needs.build-android-apks.result != 'failure'
    strategy:
      matrix:
        split: [1, 2]
      fail-fast: false
    uses: ./.github/workflows/run-e2e-workflow.yml
    with:
      test-suite-name: smoke-wallet-platform-android-part${{ matrix.split }}
      platform: android
      test_suite_tag: ".*SmokeWalletPlatform.*"
      split_number: ${{ matrix.split }}
      total_splits: 2
    secrets: inherit

  smoke-identity-ios:
    name: "Identity Smoke (iOS) - Part ${{ matrix.split }}"
    if: false
    strategy:
      matrix:
        split: [1, 2]
      fail-fast: false
    uses: ./.github/workflows/run-e2e-workflow.yml
    with:
      test-suite-name: smoke-identity-ios-part${{ matrix.split }}
      platform: ios
      test_suite_tag: ".*SmokeIdentity.*"
      split_number: ${{ matrix.split }}
      total_splits: 2
    secrets: inherit

  smoke-identity-android:
    name: "Identity Smoke (Android) - Part ${{ matrix.split }}"
    needs: build-android-apks
    if: always() && needs.build-android-apks.result != 'failure'
    strategy:
      matrix:
        split: [1, 2]
      fail-fast: false
    uses: ./.github/workflows/run-e2e-workflow.yml
    with:
      test-suite-name: smoke-identity-android-part${{ matrix.split }}
      platform: android
      test_suite_tag: ".*SmokeIdentity.*"
      split_number: ${{ matrix.split }}
      total_splits: 2
    secrets: inherit

  smoke-accounts-ios:
    name: "Accounts Smoke (iOS) - Part ${{ matrix.split }}"
    if: false
    strategy:
      matrix:
        split: [1, 2]
      fail-fast: false
    uses: ./.github/workflows/run-e2e-workflow.yml
    with:
      test-suite-name: smoke-accounts-ios-part${{ matrix.split }}
      platform: ios
      test_suite_tag: ".*SmokeAccounts.*"
      split_number: ${{ matrix.split }}
      total_splits: 2
    secrets: inherit

  smoke-accounts-android:
    name: "Accounts Smoke (Android) - Part ${{ matrix.split }}"
    needs: build-android-apks
    if: always() && needs.build-android-apks.result != 'failure'
    strategy:
      matrix:
        split: [1, 2]
      fail-fast: false
    uses: ./.github/workflows/run-e2e-workflow.yml
    with:
      test-suite-name: smoke-accounts-android-part${{ matrix.split }}
      platform: android
      test_suite_tag: ".*SmokeAccounts.*"
      split_number: ${{ matrix.split }}
      total_splits: 2
    secrets: inherit

  smoke-network-abstraction-ios:
    name: "Network Abstraction Smoke (iOS) - Part ${{ matrix.split }}"
    if: false
    strategy:
      matrix:
        split: [1, 2]
      fail-fast: false
    uses: ./.github/workflows/run-e2e-workflow.yml
    with:
      test-suite-name: smoke-network-abstraction-ios-part${{ matrix.split }}
      platform: ios
      test_suite_tag: ".*SmokeNetworkAbstraction.*"
      split_number: ${{ matrix.split }}
      total_splits: 2
    secrets: inherit

  smoke-network-abstraction-android:
    name: "Network Abstraction Smoke (Android) - Part ${{ matrix.split }}"
    needs: build-android-apks
    if: always() && needs.build-android-apks.result != 'failure'
    strategy:
      matrix:
        split: [1, 2]
      fail-fast: false
    uses: ./.github/workflows/run-e2e-workflow.yml
    with:
      test-suite-name: smoke-network-abstraction-android-part${{ matrix.split }}
      platform: android
      test_suite_tag: ".*SmokeNetworkAbstraction.*"
      split_number: ${{ matrix.split }}
      total_splits: 2
    secrets: inherit

  smoke-network-expansion-ios:
    name: "Network Expansion Smoke (iOS) - Part ${{ matrix.split }}"
    if: false
    strategy:
      matrix:
        split: [1, 2]
      fail-fast: false
    uses: ./.github/workflows/run-e2e-workflow.yml
    with:
      test-suite-name: smoke-network-expansion-ios-part${{ matrix.split }}
      platform: ios
      test_suite_tag: ".*NetworkExpansion.*"
      split_number: ${{ matrix.split }}
      total_splits: 2
    secrets: inherit

  smoke-network-expansion-android:
    name: "Network Expansion Smoke (Android) - Part ${{ matrix.split }}"
    needs: build-android-apks
    if: always() && needs.build-android-apks.result != 'failure'
    strategy:
      matrix:
        split: [1, 2]
      fail-fast: false
    uses: ./.github/workflows/run-e2e-workflow.yml
    with:
      test-suite-name: smoke-network-expansion-android-part${{ matrix.split }}
      platform: android
      test_suite_tag: ".*NetworkExpansion.*"
      split_number: ${{ matrix.split }}
      total_splits: 2
    secrets: inherit

  smoke-performance-ios:
    name: "Performance Smoke (iOS) - Part ${{ matrix.split }}"
    if: false
    strategy:
      matrix:
        split: [1, 2]
      fail-fast: false
    uses: ./.github/workflows/run-e2e-workflow.yml
    with:
      test-suite-name: smoke-performance-ios-part${{ matrix.split }}
      platform: ios
      test_suite_tag: ".*Performance.*"
      split_number: ${{ matrix.split }}
      total_splits: 2
    secrets: inherit

  smoke-performance-android:
    name: "Performance Smoke (Android) - Part ${{ matrix.split }}"
    needs: build-android-apks
    if: always() && needs.build-android-apks.result != 'failure'
    strategy:
      matrix:
        split: [1, 2]
      fail-fast: false
    uses: ./.github/workflows/run-e2e-workflow.yml
    with:
      test-suite-name: smoke-performance-android-part${{ matrix.split }}
      platform: android
      test_suite_tag: ".*Performance.*"
      split_number: ${{ matrix.split }}
      total_splits: 2
    secrets: inherit

  smoke-api-specs:
    name: "API Specs E2E"
    if: false
    uses: ./.github/workflows/run-e2e-api-specs.yml
    secrets: inherit

  report-e2e-smoke-tests:
    name: Report E2E Smoke Tests
    runs-on: ubuntu-latest
    if: false
    needs:
      - smoke-confirmations-ios
      - smoke-confirmations-android
      - smoke-confirmations-redesigned-ios
      - smoke-trade-ios
      - smoke-trade-android
      - smoke-wallet-platform-ios
      - smoke-wallet-platform-android
      - smoke-identity-ios
      - smoke-identity-android
      - smoke-accounts-ios
      - smoke-accounts-android
      - smoke-network-abstraction-ios
      - smoke-network-abstraction-android
      - smoke-network-expansion-ios
      - smoke-network-expansion-android
      - smoke-performance-ios
      - smoke-performance-android
      - smoke-api-specs

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: all-test-results/
          pattern: "*-test-results"

      - name: Post Test Report
        uses: dorny/test-reporter@dc3a92680fcc15842eef52e8c4606ea7ce6bd3f3
        with:
          name: "E2E Smoke Test Results"
          path: "all-test-results/**/*.xml"
          reporter: "jest-junit"
          fail-on-error: false
          list-suites: "all"
          list-tests: "all"

      - name: Upload merged report
        uses: actions/upload-artifact@v4
        with:
          name: merged-test-report
          path: all-test-results/**/*.xml
