# Pure Android E2E build workflow - just builds APKs and uploads artifacts
# No testing, no unnecessary setup - optimized for speed and efficiency

name: Build Android E2E APKs

on:
  workflow_call:
    inputs:
      should_build_android:
        description: 'Whether to force building Android artifacts (otherwise try cache)'
        required: false
        default: true
        type: boolean
    outputs:
      apk-uploaded:
        description: 'Whether the APK was successfully uploaded'
        value: ${{ jobs.build-android-apks.outputs.apk-uploaded }}
      aab-uploaded:
        description: 'Whether the AAB was successfully uploaded'
        value: ${{ jobs.build-android-apks.outputs.aab-uploaded }}
      sourcemap-uploaded:
        description: 'Whether the sourcemap was successfully uploaded'
        value: ${{ jobs.build-android-apks.outputs.sourcemap-uploaded }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ !(contains(github.ref, 'refs/heads/main') || contains(github.ref, 'refs/heads/stable')) }}

jobs:
  build-android-apks:
    name: Build Android E2E APKs
    runs-on: gha-mmsdk-scale-set-ubuntu-22.04-amd64-xl
    outputs:
      apk-uploaded: ${{ steps.upload-apk.outcome == 'success' }}
      aab-uploaded: ${{ steps.upload-aab.outcome == 'success' }}
      sourcemap-uploaded: ${{ steps.upload-sourcemap.outcome == 'success' }}
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Restore cached Android build artifacts (if any)
        id: restore-cache
        uses: actions/cache@v4
        with:
          path: |
            cached-artifacts/android
          key: android-apk-${{ hashFiles('android/**', 'app/**', 'scripts/**', 'package.json', 'yarn.lock', '**/*.gradle*', '**/gradle-wrapper.properties') }}

      - name: Use cached artifacts instead of building
        if: ${{ !inputs.should_build_android && steps.restore-cache.outputs.cache-hit == 'true' }}
        run: |
          echo "üîÅ Using cached Android artifacts"
          mkdir -p android/app/build/outputs/apk/prod/release/
          mkdir -p android/app/build/outputs/apk/androidTest/prod/release/
          mkdir -p android/app/build/outputs/bundle/prodRelease/
          mkdir -p sourcemaps/android/

          cp cached-artifacts/android/app-prod-release.apk android/app/build/outputs/apk/prod/release/app-prod-release.apk
          cp cached-artifacts/android/app-prod-release-androidTest.apk android/app/build/outputs/apk/androidTest/prod/release/app-prod-release-androidTest.apk
          if [ -f cached-artifacts/android/app-prod-release.aab ]; then
            cp cached-artifacts/android/app-prod-release.aab android/app/build/outputs/bundle/prodRelease/app-prod-release.aab || true
          fi
          if [ -f cached-artifacts/android/index.android.bundle.map ]; then
            cp cached-artifacts/android/index.android.bundle.map sourcemaps/android/index.android.bundle.map || true
          fi

      - name: Setup Android Build Environment
        if: ${{ inputs.should_build_android || steps.restore-cache.outputs.cache-hit != 'true' }}
        uses: MetaMask/github-tools/.github/actions/setup-e2e-env@self-hosted-runners-config
        with:
          platform: android
          setup-simulator: false
          configure-keystores: true
          target: qa

      - name: Cache Gradle dependencies
        if: ${{ inputs.should_build_android || steps.restore-cache.outputs.cache-hit != 'true' }}
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            android/.gradle
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Build Android E2E APKs
        if: ${{ inputs.should_build_android || steps.restore-cache.outputs.cache-hit != 'true' }}
        run: |
          echo "üöÄ Setting up project..."
          yarn setup:github-ci --no-build-ios
          
          echo "üèó Building Android E2E APKs..."
          export NODE_OPTIONS="--max-old-space-size=8192"
          cp android/gradle.properties.github android/gradle.properties
          yarn build:android:main:e2e
        shell: bash
        env:
          PLATFORM: android
          METAMASK_ENVIRONMENT: qa
          METAMASK_BUILD_TYPE: main
          IS_TEST: true
          E2E: "true"
          IGNORE_BOXLOGS_DEVELOPMENT: true
          GITHUB_CI: "true"
          CI: "true"
          NODE_OPTIONS: "--max-old-space-size=8192"
          MM_UNIFIED_SWAPS_ENABLED: "true"
          MM_BRIDGE_ENABLED: "true"
          BRIDGE_USE_DEV_APIS: "true"
          RAMP_INTERNAL_BUILD: "true"
          SEGMENT_WRITE_KEY_QA: ${{ secrets.SEGMENT_WRITE_KEY_QA }}
          SEGMENT_PROXY_URL_QA: ${{ secrets.SEGMENT_PROXY_URL_QA }}
          SEGMENT_DELETE_API_SOURCE_ID_QA: ${{ secrets.SEGMENT_DELETE_API_SOURCE_ID_QA }}
          SEGMENT_REGULATIONS_ENDPOINT_QA: ${{ secrets.SEGMENT_REGULATIONS_ENDPOINT_QA }}
          MM_SENTRY_DSN_TEST: ${{ secrets.MM_SENTRY_DSN_TEST }}
          MM_SENTRY_AUTH_TOKEN: ${{ secrets.MM_SENTRY_AUTH_TOKEN }}
          MAIN_IOS_GOOGLE_CLIENT_ID_UAT: ${{ secrets.MAIN_IOS_GOOGLE_CLIENT_ID_UAT }}
          MAIN_IOS_GOOGLE_REDIRECT_URI_UAT: ${{ secrets.MAIN_IOS_GOOGLE_REDIRECT_URI_UAT }}
          MAIN_ANDROID_APPLE_CLIENT_ID_UAT: ${{ secrets.MAIN_ANDROID_APPLE_CLIENT_ID_UAT }}
          MAIN_ANDROID_GOOGLE_CLIENT_ID_UAT: ${{ secrets.MAIN_ANDROID_GOOGLE_CLIENT_ID_UAT }}
          MAIN_ANDROID_GOOGLE_SERVER_CLIENT_ID_UAT: ${{ secrets.MAIN_ANDROID_GOOGLE_SERVER_CLIENT_ID_UAT }}
          GOOGLE_SERVICES_B64_IOS: ${{ secrets.GOOGLE_SERVICES_B64_IOS }}
          GOOGLE_SERVICES_B64_ANDROID: ${{ secrets.GOOGLE_SERVICES_B64_ANDROID }}
          MM_INFURA_PROJECT_ID: ${{ secrets.MM_INFURA_PROJECT_ID }}

      - name: Save build artifacts into cache directory
        if: ${{ inputs.should_build_android || steps.restore-cache.outputs.cache-hit != 'true' }}
        run: |
          mkdir -p cached-artifacts/android
          cp android/app/build/outputs/apk/prod/release/app-prod-release.apk cached-artifacts/android/app-prod-release.apk
          cp android/app/build/outputs/apk/androidTest/prod/release/app-prod-release-androidTest.apk cached-artifacts/android/app-prod-release-androidTest.apk
          if [ -f android/app/build/outputs/bundle/prodRelease/app-prod-release.aab ]; then
            cp android/app/build/outputs/bundle/prodRelease/app-prod-release.aab cached-artifacts/android/app-prod-release.aab || true
          fi
          if [ -f sourcemaps/android/index.android.bundle.map ]; then
            cp sourcemaps/android/index.android.bundle.map cached-artifacts/android/index.android.bundle.map || true
          fi

      - name: Save Android build artifacts cache
        if: ${{ inputs.should_build_android || steps.restore-cache.outputs.cache-hit != 'true' }}
        uses: actions/cache/save@v4
        with:
          path: |
            cached-artifacts/android
          key: android-apk-${{ hashFiles('android/**', 'app/**', 'scripts/**', 'package.json', 'yarn.lock', '**/*.gradle*', '**/gradle-wrapper.properties') }}

      - name: Upload Android APK
        id: upload-apk
        uses: actions/upload-artifact@v4
        with:
          name: app-prod-release.apk
          path: android/app/build/outputs/apk/prod/release/app-prod-release.apk
          retention-days: 7
          if-no-files-found: error

      - name: Upload Android Test APK
        id: upload-test-apk
        uses: actions/upload-artifact@v4
        with:
          name: app-prod-release-androidTest.apk
          path: android/app/build/outputs/apk/androidTest/prod/release/app-prod-release-androidTest.apk
          retention-days: 7
          if-no-files-found: error

      - name: Upload Android AAB
        id: upload-aab
        uses: actions/upload-artifact@v4
        with:
          name: app-prod-release.aab
          path: android/app/build/outputs/bundle/prodRelease/app-prod-release.aab
          retention-days: 7
          if-no-files-found: warn
        continue-on-error: true

      - name: Upload Android Source Map
        id: upload-sourcemap
        uses: actions/upload-artifact@v4
        with:
          name: index.android.bundle.map
          path: sourcemaps/android/index.android.bundle.map
          retention-days: 7
          if-no-files-found: warn
        continue-on-error: true
