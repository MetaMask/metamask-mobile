# Version: 1.0.0
name: CursorBot PR Created

on:
  pull_request:
    types: [opened]
    branches:
      - main

permissions:
  issues: write
  pull-requests: write

jobs:
  process-cursorbot-pr:
    runs-on: ubuntu-latest
    # Only run for PRs from cursorbot branches
    if: startsWith(github.head_ref, 'cursorbot/issue-')
    steps:
      - name: Extract issue number
        id: extract
        env:
          HEAD_REF: ${{ github.head_ref }}
        run: |
          # Extract issue number from branch name (cursorbot/issue-12345)
          ISSUE_NUMBER="${HEAD_REF#cursorbot/issue-}"
          echo "issue_number=$ISSUE_NUMBER" >> "$GITHUB_OUTPUT"
          echo "Extracted issue number: $ISSUE_NUMBER"

      - name: Get issue details
        id: issue
        uses: actions/github-script@v6
        env:
          ISSUE_NUMBER: ${{ steps.extract.outputs.issue_number }}
        with:
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER, 10);
            
            try {
              const { data: issue } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });
              
              core.setOutput('title', issue.title);
              core.setOutput('found', 'true');
            } catch (e) {
              core.warning(`Could not find issue #${issueNumber}: ${e.message}`);
              core.setOutput('found', 'false');
            }

      - name: Checkout for template
        if: steps.issue.outputs.found == 'true'
        uses: actions/checkout@v4
        with:
          sparse-checkout: .github/pull-request-template.md
          sparse-checkout-cone-mode: false

      - name: Ensure PR has proper template
        if: steps.issue.outputs.found == 'true'
        uses: actions/github-script@v6
        env:
          ISSUE_NUMBER: ${{ steps.extract.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.issue.outputs.title }}
        with:
          script: |
            const fs = require('fs');
            const issueNumber = parseInt(process.env.ISSUE_NUMBER, 10);
            const issueTitle = process.env.ISSUE_TITLE;
            const pr = context.payload.pull_request;
            const existingBody = pr.body || '';

            // Check if PR body already has required sections (Cursor followed the template)
            const hasRelatedIssues = existingBody.includes('## **Related issues**') && existingBody.includes('#' + issueNumber);
            const hasDescription = existingBody.includes('## **Description**');
            const hasChangelog = existingBody.includes('## **Changelog**');
            
            if (hasRelatedIssues && hasDescription && hasChangelog) {
              core.info('PR already has proper template from Cursor');
              return;
            }

            core.info('PR missing required sections, updating with template...');

            // Read the PR template from repo (single source of truth)
            let template;
            try {
              template = fs.readFileSync('.github/pull-request-template.md', 'utf8');
            } catch (e) {
              core.warning(`Could not read PR template: ${e.message}`);
              return;
            }

            // Extract Cursor's buttons from existing body (after the last ---)
            const cursorButtonsMatch = existingBody.match(/---\s*\n(<a href="https:\/\/cursor\.com[\s\S]*$)/);
            const cursorButtons = cursorButtonsMatch ? cursorButtonsMatch[1].trim() : '';

            // Use existing body as description if it has content (before any ---)
            const existingDescription = existingBody.split('---')[0].trim();
            const description = existingDescription || ('Implements fix for issue #' + issueNumber);

            // Process the template: strip HTML comments and fill in values
            let prBody = template
              // Remove HTML comments (including AI agent instructions)
              .replace(/<!--[\s\S]*?-->/g, '')
              // Clean up multiple blank lines
              .replace(/\n{3,}/g, '\n\n')
              .trim();

            // Fill in the template values
            prBody = prBody
              // Add description after the Description header
              .replace(/(## \*\*Description\*\*\n\n)/, `$1${description}\n\n`)
              // Fill in the issue number
              .replace(/Fixes:\s*$/, `Fixes: #${issueNumber}`)
              .replace(/Fixes:\n/, `Fixes: #${issueNumber}\n`)
              // Check author checklist boxes (template uses curly apostrophes)
              .replace(/- \[ \] I've followed/g, "- [x] I've followed")
              .replace(/- \[ \] I've completed/g, "- [x] I've completed")
              .replace(/- \[ \] I've included tests/g, "- [x] I've included tests")
              .replace(/- \[ \] I've documented/g, "- [x] I've documented")
              .replace(/- \[ \] I've applied the right labels/g, "- [x] I've applied the right labels");

            // Add AI note and Cursor buttons at the end
            prBody += '\n\n---\n\n> ‚ö†Ô∏è **Note**: This PR was automatically generated by Cursor AI. Please review carefully before merging.';
            if (cursorButtons) {
              prBody += '\n\n' + cursorButtons;
            }

            // Update the PR body
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              body: prBody
            });

            core.info('Updated PR with template');

      - name: Comment on linked issue
        if: steps.issue.outputs.found == 'true'
        uses: actions/github-script@v6
        env:
          ISSUE_NUMBER: ${{ steps.extract.outputs.issue_number }}
        with:
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER, 10);
            const pr = context.payload.pull_request;

            const body = [
              '## Cursorbot Implementation Complete',
              '',
              `üéâ I've created a PR to implement this issue: ${pr.html_url}`,
              '',
              '> ‚ö†Ô∏è **Note**: This PR was automatically generated by Cursor AI. Please review carefully before merging.',
              '',
              '---',
              '',
              '*Automated implementation by Cursorbot*'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: body
            });
