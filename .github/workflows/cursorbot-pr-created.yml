# Version: 1.0.0
name: CursorBot PR Created

on:
  pull_request:
    types: [opened]
    branches:
      - main

permissions:
  issues: write
  pull-requests: write

jobs:
  process-cursorbot-pr:
    runs-on: ubuntu-latest
    # Only run for PRs from cursorbot branches
    if: startsWith(github.head_ref, 'cursorbot/issue-')
    steps:
      - name: Extract issue number
        id: extract
        run: |
          # Extract issue number from branch name (cursorbot/issue-12345)
          BRANCH="${{ github.head_ref }}"
          ISSUE_NUMBER="${BRANCH#cursorbot/issue-}"
          echo "issue_number=$ISSUE_NUMBER" >> "$GITHUB_OUTPUT"
          echo "Extracted issue number: $ISSUE_NUMBER"

      - name: Get issue details
        id: issue
        uses: actions/github-script@v6
        env:
          ISSUE_NUMBER: ${{ steps.extract.outputs.issue_number }}
        with:
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER, 10);
            
            try {
              const { data: issue } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });
              
              core.setOutput('title', issue.title);
              core.setOutput('found', 'true');
            } catch (e) {
              core.warning(`Could not find issue #${issueNumber}: ${e.message}`);
              core.setOutput('found', 'false');
            }

      - name: Ensure PR has proper template
        if: steps.issue.outputs.found == 'true'
        uses: actions/github-script@v6
        env:
          ISSUE_NUMBER: ${{ steps.extract.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.issue.outputs.title }}
        with:
          script: |
            const issueNumber = process.env.ISSUE_NUMBER;
            const issueTitle = process.env.ISSUE_TITLE;
            const pr = context.payload.pull_request;
            const existingBody = pr.body || '';

            // Check if PR body already has required sections (Cursor followed the template)
            const hasRelatedIssues = existingBody.includes('## **Related issues**') && existingBody.includes('#' + issueNumber);
            const hasDescription = existingBody.includes('## **Description**');
            const hasChangelog = existingBody.includes('## **Changelog**');
            
            if (hasRelatedIssues && hasDescription && hasChangelog) {
              core.info('PR already has proper template from Cursor');
              return;
            }

            core.info('PR missing required sections, updating with template...');

            // Extract Cursor's buttons from existing body (after the last ---)
            const cursorButtonsMatch = existingBody.match(/---\s*\n(<a href="https:\/\/cursor\.com[\s\S]*$)/);
            const cursorButtons = cursorButtonsMatch ? cursorButtonsMatch[1].trim() : '';

            // Use existing body as description if it has content (before any ---)
            const existingDescription = existingBody.split('---')[0].trim();
            const description = existingDescription || ('Implements fix for issue #' + issueNumber);

            // Build PR body following the template
            const prBody = [
              '## **Description**',
              '',
              description,
              '',
              '## **Changelog**',
              '',
              'CHANGELOG entry:',
              '',
              '## **Related issues**',
              '',
              'Fixes: #' + issueNumber,
              '',
              '## **Manual testing steps**',
              '',
              '```gherkin',
              'Feature: ' + issueTitle,
              '',
              'Scenario: Verify the fix works as expected',
              'Given the app is in the initial state described in the issue',
              'When user performs the action that previously caused the bug',
              'Then the expected behavior occurs without the bug',
              '```',
              '',
              '## **Screenshots/Recordings**',
              '',
              '### **Before**',
              '',
              '<!-- See issue #' + issueNumber + ' for bug screenshots -->',
              '',
              '### **After**',
              '',
              '<!-- Manual verification needed -->',
              '',
              '## **Pre-merge author checklist**',
              '',
              "- [x] I've followed MetaMask Contributor Docs and MetaMask Mobile Coding Standards.",
              "- [x] I've completed the PR template to the best of my ability",
              "- [x] I've included tests if applicable",
              "- [x] I've documented my code using JSDoc format if applicable",
              "- [x] I've applied the right labels on the PR (see labeling guidelines). Not required for external contributors.",
              '',
              '## **Pre-merge reviewer checklist**',
              '',
              "- [ ] I've manually tested the PR (e.g. pull and build branch, run the app, test code being changed).",
              '- [ ] I confirm that this PR addresses all acceptance criteria described in the ticket it closes and includes the necessary testing evidence such as recordings and or screenshots.',
              '',
              '---',
              '',
              '> ‚ö†Ô∏è **Note**: This PR was automatically generated by Cursor AI. Please review carefully before merging.',
              '',
              cursorButtons
            ].join('\n');

            // Update the PR body
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              body: prBody
            });

            core.info('Updated PR with template');

      - name: Comment on linked issue
        if: steps.issue.outputs.found == 'true'
        uses: actions/github-script@v6
        env:
          ISSUE_NUMBER: ${{ steps.extract.outputs.issue_number }}
        with:
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER, 10);
            const pr = context.payload.pull_request;

            const body = [
              '## Cursorbot Implementation Complete',
              '',
              `üéâ I've created a PR to implement this issue: ${pr.html_url}`,
              '',
              '> ‚ö†Ô∏è **Note**: This PR was automatically generated by Cursor AI. Please review carefully before merging.',
              '',
              '---',
              '',
              '*Automated implementation by Cursorbot*'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: body
            });
