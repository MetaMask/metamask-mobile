# This workflow creates two non E2E iOS Builds and uploads to BrowserStack
# Build 1: With ADDITIONAL_SRP_1 and PREDEFINED_PASSWORD (pre-imported wallet) 
# Build 2: Without these environment variables (fresh wallet)
# Both builds run on GitHub Actions macOS runners (migrated from Bitrise)

name: Build iOS Dual Versions and Upload to BrowserStack

on:
  workflow_call:
    inputs:
      browserstack_app_url_ios_onboarding:
        required: false
        type: string
        description: 'BrowserStack iOS Onboarding App URL (bs://...)'
      browserstack_app_url_ios_imported_wallet:
        required: false
        type: string
        description: 'BrowserStack iOS Imported Wallet App URL (bs://...)'
    outputs:
      with-srp-ipa-uploaded:
        description: 'Whether the with-SRP IPA was successfully uploaded'
        value: ${{ jobs.upload-to-browserstack.outputs.with-srp-ipa-uploaded }}
      without-srp-ipa-uploaded:
        description: 'Whether the without-SRP IPA was successfully uploaded'
        value: ${{ jobs.upload-to-browserstack.outputs.without-srp-ipa-uploaded }}
      with-srp-browserstack-url:
        description: 'BrowserStack URL for with-SRP version'
        value: ${{ jobs.upload-to-browserstack.outputs.with-srp-browserstack-url }}
      without-srp-browserstack-url:
        description: 'BrowserStack URL for without-SRP version'
        value: ${{ jobs.upload-to-browserstack.outputs.without-srp-browserstack-url }}
      with-srp-version:
        description: 'App version for with-SRP build'
        value: ${{ jobs.upload-to-browserstack.outputs.with-srp-version }}
      without-srp-version:
        description: 'App version for without-SRP build'
        value: ${{ jobs.upload-to-browserstack.outputs.without-srp-version }}
  workflow_dispatch:
    inputs:
      description:
        description: 'Optional description for this build run'
        required: false
        type: string

permissions:
  contents: read
  id-token: write

env:
  BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
  BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}

jobs:
  check-builds-needed:
    name: Check if iOS builds are needed
    runs-on: ubuntu-latest
    outputs:
      builds-needed: ${{ steps.check-builds.outputs.builds-needed }}
    
    steps:
      - name: Check if builds are needed
        id: check-builds
        run: |
          # Check if any BS URLs are provided via workflow inputs
          if [ -n "${{ inputs.browserstack_app_url_ios_onboarding }}" ] || [ -n "${{ inputs.browserstack_app_url_ios_imported_wallet }}" ]; then
            echo "builds-needed=false" >> "$GITHUB_OUTPUT"
            echo "Skipping iOS builds - BS URLs provided via workflow inputs"
          else
            echo "builds-needed=true" >> "$GITHUB_OUTPUT"
            echo "iOS builds needed - no BS URLs provided"
          fi

  build-ios-with-srp:
    name: Build iOS with-SRP (Device)
    runs-on: ghcr.io/cirruslabs/macos-runner:sequoia-xl
    needs: [check-builds-needed]
    if: needs.check-builds-needed.outputs.builds-needed == 'true'
    outputs:
      build-success: ${{ steps.build-ipa.outcome == 'success' }}
    env:
      RCT_NO_LAUNCH_PACKAGER: 1
      XCODE_BUILD_SETTINGS: 'COMPILER_INDEX_STORE_ENABLE=NO'
      GITHUB_CI: 'true'
      PLATFORM: ios
      METAMASK_ENVIRONMENT: rc
      METAMASK_BUILD_TYPE: main
      CI: 'true'
      NODE_OPTIONS: '--max-old-space-size=8192'
      # Environment variables for with-SRP build
      ADDITIONAL_SRP_1: ${{ secrets.IN_BUILD_SRP }}
      PREDEFINED_PASSWORD: ${{ secrets.E2E_PASSWORD }}
      DISABLE_NOTIFICATION_PROMPT: 'true'
      # Build secrets
      SEGMENT_WRITE_KEY_QA: ${{ secrets.SEGMENT_WRITE_KEY_QA }}
      SEGMENT_PROXY_URL_QA: ${{ secrets.SEGMENT_PROXY_URL_QA }}
      SEGMENT_DELETE_API_SOURCE_ID_QA: ${{ secrets.SEGMENT_DELETE_API_SOURCE_ID_QA }}
      SEGMENT_REGULATIONS_ENDPOINT_QA: ${{ secrets.SEGMENT_REGULATIONS_ENDPOINT_QA }}
      MM_SENTRY_DSN_TEST: ${{ secrets.MM_SENTRY_DSN_TEST }}
      MM_SENTRY_AUTH_TOKEN: ${{ secrets.MM_SENTRY_AUTH_TOKEN }}
      MAIN_IOS_GOOGLE_CLIENT_ID_PROD: ${{ secrets.MAIN_IOS_GOOGLE_CLIENT_ID_PROD }}
      MAIN_IOS_GOOGLE_REDIRECT_URI_PROD: ${{ secrets.MAIN_IOS_GOOGLE_REDIRECT_URI_PROD }}
      MAIN_ANDROID_APPLE_CLIENT_ID_PROD: ${{ secrets.MAIN_ANDROID_APPLE_CLIENT_ID_PROD }}
      MAIN_ANDROID_GOOGLE_CLIENT_ID_PROD: ${{ secrets.MAIN_ANDROID_GOOGLE_CLIENT_ID_PROD }}
      MAIN_ANDROID_GOOGLE_SERVER_CLIENT_ID_PROD: ${{ secrets.MAIN_ANDROID_GOOGLE_SERVER_CLIENT_ID_PROD }}
      GOOGLE_SERVICES_B64_IOS: ${{ secrets.GOOGLE_SERVICES_B64_IOS }}
      GOOGLE_SERVICES_B64_ANDROID: ${{ secrets.GOOGLE_SERVICES_B64_ANDROID }}
      MM_INFURA_PROJECT_ID: ${{ secrets.MM_INFURA_PROJECT_ID }}
      FEATURES_ANNOUNCEMENTS_ACCESS_TOKEN: ${{ secrets.FEATURES_ANNOUNCEMENTS_ACCESS_TOKEN }}
      FEATURES_ANNOUNCEMENTS_SPACE_ID: ${{ secrets.FEATURES_ANNOUNCEMENTS_SPACE_ID }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Cache Xcode derived data
        uses: cirruslabs/cache@0ea6c28a9b52ff2a1a01354742d8fbe0c4599693
        env:
          XCODE_CACHE_VERSION: 1
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
            ios/build
          key: ${{ runner.os }}-xcode-device-${{ env.XCODE_CACHE_VERSION }}-${{ hashFiles('ios/**/*.{h,m,mm,swift}', 'ios/**/Podfile.lock', 'yarn.lock') }}

      - name: Installing iOS Environment Setup
        uses: MetaMask/github-tools/.github/actions/setup-e2e-env@v1
        with:
          platform: ios
          setup-simulator: false

      - name: Print iOS tool versions
        run: |
          echo "üîß Node.js Version:"
          node -v || echo "Node not found"
          echo "üß∂ Yarn Version:"
          yarn -v || echo "Yarn not found"
          echo "üì¶ CocoaPods Version:"
          pod --version || echo "CocoaPods not found"
          echo "üõ†Ô∏è Xcode Path:"
          xcode-select -p || echo "Xcode not found"
          echo "üì± Xcode Version:"
          xcodebuild -version || echo "Xcode not found"
        shell: bash

      - name: Clean iOS plist files
        run: find ios -name "*.plist" -exec xattr -c {} \;

      # Code signing setup
      - name: Install Apple certificate and provisioning profile
        env:
          IOS_DISTRIBUTION_CERTIFICATE_P12_B64: ${{ secrets.IOS_DISTRIBUTION_CERTIFICATE_P12_B64 }}
          IOS_DISTRIBUTION_CERTIFICATE_PASSWORD: ${{ secrets.IOS_DISTRIBUTION_CERTIFICATE_PASSWORD }}
          IOS_PROVISIONING_PROFILE_B64: ${{ secrets.IOS_PROVISIONING_PROFILE_B64 }}
          KEYCHAIN_PASSWORD: ${{ github.run_id }}
        run: |
          echo "üîê Setting up code signing..."
          
          # Create variables
          CERTIFICATE_PATH="$RUNNER_TEMP/build_certificate.p12"
          PP_PATH="$RUNNER_TEMP/build_pp.mobileprovision"
          KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"
          
          # Decode certificate and provisioning profile
          echo -n "$IOS_DISTRIBUTION_CERTIFICATE_P12_B64" | base64 --decode -o "$CERTIFICATE_PATH"
          echo -n "$IOS_PROVISIONING_PROFILE_B64" | base64 --decode -o "$PP_PATH"
          
          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          
          # Import certificate to keychain
          security import "$CERTIFICATE_PATH" -P "$IOS_DISTRIBUTION_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"
          
          # Copy provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp "$PP_PATH" ~/Library/MobileDevice/Provisioning\ Profiles/
          
          echo "‚úÖ Code signing setup complete"

      - name: Setup project dependencies with retry
        uses: nick-fields/retry@ce71cc2ab81d554ebbe88c79ab5975992d79ba08 #v3.0.2
        with:
          timeout_minutes: 15
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            echo "üöÄ Setting up project..."
            yarn setup:github-ci --build-ios --no-build-android

      - name: Build iOS IPA (Device)
        id: build-ipa
        run: |
          echo "üèó Building iOS IPA for device..."
          export NODE_OPTIONS="--max-old-space-size=8192"
          yarn build:ios:main:rc
        shell: bash
        env:
          PLATFORM: ios
          METAMASK_ENVIRONMENT: rc
          METAMASK_BUILD_TYPE: main
          IS_SIM_BUILD: 'false'
          CONFIGURATION: Release
          ADDITIONAL_SRP_1: ${{ secrets.IN_BUILD_SRP }}
          PREDEFINED_PASSWORD: ${{ secrets.E2E_PASSWORD }}
          DISABLE_NOTIFICATION_PROMPT: 'true'

      - name: Find and rename IPA
        id: find-ipa
        run: |
          echo "üì¶ Looking for IPA file..."
          # Find the IPA in the build output directory
          IPA_PATH=$(find ios/build/output -name "*.ipa" -type f 2>/dev/null | head -1)
          
          if [ -z "$IPA_PATH" ]; then
            echo "‚ùå No IPA found in ios/build/output"
            find ios/build -name "*.ipa" -type f 2>/dev/null || echo "No IPA files found anywhere"
            exit 1
          fi
          
          echo "‚úÖ Found IPA: $IPA_PATH"
          
          # Rename to a standard name for artifact upload
          cp "$IPA_PATH" "ios/build/output/metamask-ios-with-srp.ipa"
          echo "ipa-path=ios/build/output/metamask-ios-with-srp.ipa" >> "$GITHUB_OUTPUT"
          
          # Get file size
          du -h "ios/build/output/metamask-ios-with-srp.ipa"

      - name: Upload iOS IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: metamask-ios-with-srp-ipa
          path: ios/build/output/metamask-ios-with-srp.ipa
          retention-days: 7
          if-no-files-found: error

      - name: Cleanup keychain
        if: always()
        run: |
          security delete-keychain "$RUNNER_TEMP/app-signing.keychain-db" || true

  build-ios-without-srp:
    name: Build iOS without-SRP (Device)
    runs-on: ghcr.io/cirruslabs/macos-runner:sequoia-xl
    needs: [check-builds-needed]
    if: needs.check-builds-needed.outputs.builds-needed == 'true'
    outputs:
      build-success: ${{ steps.build-ipa.outcome == 'success' }}
    env:
      RCT_NO_LAUNCH_PACKAGER: 1
      XCODE_BUILD_SETTINGS: 'COMPILER_INDEX_STORE_ENABLE=NO'
      GITHUB_CI: 'true'
      PLATFORM: ios
      METAMASK_ENVIRONMENT: rc
      METAMASK_BUILD_TYPE: main
      CI: 'true'
      NODE_OPTIONS: '--max-old-space-size=8192'
      # Environment variables for without-SRP build (no ADDITIONAL_SRP_1 or PREDEFINED_PASSWORD)
      DISABLE_NOTIFICATION_PROMPT: 'true'
      # Build secrets
      SEGMENT_WRITE_KEY_QA: ${{ secrets.SEGMENT_WRITE_KEY_QA }}
      SEGMENT_PROXY_URL_QA: ${{ secrets.SEGMENT_PROXY_URL_QA }}
      SEGMENT_DELETE_API_SOURCE_ID_QA: ${{ secrets.SEGMENT_DELETE_API_SOURCE_ID_QA }}
      SEGMENT_REGULATIONS_ENDPOINT_QA: ${{ secrets.SEGMENT_REGULATIONS_ENDPOINT_QA }}
      MM_SENTRY_DSN_TEST: ${{ secrets.MM_SENTRY_DSN_TEST }}
      MM_SENTRY_AUTH_TOKEN: ${{ secrets.MM_SENTRY_AUTH_TOKEN }}
      MAIN_IOS_GOOGLE_CLIENT_ID_PROD: ${{ secrets.MAIN_IOS_GOOGLE_CLIENT_ID_PROD }}
      MAIN_IOS_GOOGLE_REDIRECT_URI_PROD: ${{ secrets.MAIN_IOS_GOOGLE_REDIRECT_URI_PROD }}
      MAIN_ANDROID_APPLE_CLIENT_ID_PROD: ${{ secrets.MAIN_ANDROID_APPLE_CLIENT_ID_PROD }}
      MAIN_ANDROID_GOOGLE_CLIENT_ID_PROD: ${{ secrets.MAIN_ANDROID_GOOGLE_CLIENT_ID_PROD }}
      MAIN_ANDROID_GOOGLE_SERVER_CLIENT_ID_PROD: ${{ secrets.MAIN_ANDROID_GOOGLE_SERVER_CLIENT_ID_PROD }}
      GOOGLE_SERVICES_B64_IOS: ${{ secrets.GOOGLE_SERVICES_B64_IOS }}
      GOOGLE_SERVICES_B64_ANDROID: ${{ secrets.GOOGLE_SERVICES_B64_ANDROID }}
      MM_INFURA_PROJECT_ID: ${{ secrets.MM_INFURA_PROJECT_ID }}
      FEATURES_ANNOUNCEMENTS_ACCESS_TOKEN: ${{ secrets.FEATURES_ANNOUNCEMENTS_ACCESS_TOKEN }}
      FEATURES_ANNOUNCEMENTS_SPACE_ID: ${{ secrets.FEATURES_ANNOUNCEMENTS_SPACE_ID }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Cache Xcode derived data
        uses: cirruslabs/cache@0ea6c28a9b52ff2a1a01354742d8fbe0c4599693
        env:
          XCODE_CACHE_VERSION: 1
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
            ios/build
          key: ${{ runner.os }}-xcode-device-${{ env.XCODE_CACHE_VERSION }}-${{ hashFiles('ios/**/*.{h,m,mm,swift}', 'ios/**/Podfile.lock', 'yarn.lock') }}

      - name: Installing iOS Environment Setup
        uses: MetaMask/github-tools/.github/actions/setup-e2e-env@v1
        with:
          platform: ios
          setup-simulator: false

      - name: Print iOS tool versions
        run: |
          echo "üîß Node.js Version:"
          node -v || echo "Node not found"
          echo "üß∂ Yarn Version:"
          yarn -v || echo "Yarn not found"
          echo "üì¶ CocoaPods Version:"
          pod --version || echo "CocoaPods not found"
          echo "üõ†Ô∏è Xcode Path:"
          xcode-select -p || echo "Xcode not found"
          echo "üì± Xcode Version:"
          xcodebuild -version || echo "Xcode not found"
        shell: bash

      - name: Clean iOS plist files
        run: find ios -name "*.plist" -exec xattr -c {} \;

      # Code signing setup
      - name: Install Apple certificate and provisioning profile
        env:
          IOS_DISTRIBUTION_CERTIFICATE_P12_B64: ${{ secrets.IOS_DISTRIBUTION_CERTIFICATE_P12_B64 }}
          IOS_DISTRIBUTION_CERTIFICATE_PASSWORD: ${{ secrets.IOS_DISTRIBUTION_CERTIFICATE_PASSWORD }}
          IOS_PROVISIONING_PROFILE_B64: ${{ secrets.IOS_PROVISIONING_PROFILE_B64 }}
          KEYCHAIN_PASSWORD: ${{ github.run_id }}
        run: |
          echo "üîê Setting up code signing..."
          
          # Create variables
          CERTIFICATE_PATH="$RUNNER_TEMP/build_certificate.p12"
          PP_PATH="$RUNNER_TEMP/build_pp.mobileprovision"
          KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"
          
          # Decode certificate and provisioning profile
          echo -n "$IOS_DISTRIBUTION_CERTIFICATE_P12_B64" | base64 --decode -o "$CERTIFICATE_PATH"
          echo -n "$IOS_PROVISIONING_PROFILE_B64" | base64 --decode -o "$PP_PATH"
          
          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          
          # Import certificate to keychain
          security import "$CERTIFICATE_PATH" -P "$IOS_DISTRIBUTION_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"
          
          # Copy provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp "$PP_PATH" ~/Library/MobileDevice/Provisioning\ Profiles/
          
          echo "‚úÖ Code signing setup complete"

      - name: Setup project dependencies with retry
        uses: nick-fields/retry@ce71cc2ab81d554ebbe88c79ab5975992d79ba08 #v3.0.2
        with:
          timeout_minutes: 15
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            echo "üöÄ Setting up project..."
            yarn setup:github-ci --build-ios --no-build-android

      - name: Build iOS IPA (Device)
        id: build-ipa
        run: |
          echo "üèó Building iOS IPA for device..."
          export NODE_OPTIONS="--max-old-space-size=8192"
          yarn build:ios:main:rc
        shell: bash
        env:
          PLATFORM: ios
          METAMASK_ENVIRONMENT: rc
          METAMASK_BUILD_TYPE: main
          IS_SIM_BUILD: 'false'
          CONFIGURATION: Release
          DISABLE_NOTIFICATION_PROMPT: 'true'

      - name: Find and rename IPA
        id: find-ipa
        run: |
          echo "üì¶ Looking for IPA file..."
          # Find the IPA in the build output directory
          IPA_PATH=$(find ios/build/output -name "*.ipa" -type f 2>/dev/null | head -1)
          
          if [ -z "$IPA_PATH" ]; then
            echo "‚ùå No IPA found in ios/build/output"
            find ios/build -name "*.ipa" -type f 2>/dev/null || echo "No IPA files found anywhere"
            exit 1
          fi
          
          echo "‚úÖ Found IPA: $IPA_PATH"
          
          # Rename to a standard name for artifact upload
          cp "$IPA_PATH" "ios/build/output/metamask-ios-without-srp.ipa"
          echo "ipa-path=ios/build/output/metamask-ios-without-srp.ipa" >> "$GITHUB_OUTPUT"
          
          # Get file size
          du -h "ios/build/output/metamask-ios-without-srp.ipa"

      - name: Upload iOS IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: metamask-ios-without-srp-ipa
          path: ios/build/output/metamask-ios-without-srp.ipa
          retention-days: 7
          if-no-files-found: error

      - name: Cleanup keychain
        if: always()
        run: |
          security delete-keychain "$RUNNER_TEMP/app-signing.keychain-db" || true

  upload-to-browserstack:
    name: Upload IPAs to BrowserStack
    runs-on: ubuntu-latest
    needs: [check-builds-needed, build-ios-with-srp, build-ios-without-srp]
    if: |
      always() && 
      needs.check-builds-needed.outputs.builds-needed == 'true' &&
      (needs.build-ios-with-srp.result == 'success' || needs.build-ios-without-srp.result == 'success')
    outputs:
      with-srp-ipa-uploaded: ${{ steps.browserstack-upload.outputs.with-srp-ipa-uploaded }}
      without-srp-ipa-uploaded: ${{ steps.browserstack-upload.outputs.without-srp-ipa-uploaded }}
      with-srp-browserstack-url: ${{ steps.browserstack-upload.outputs.with-srp-browserstack-url }}
      without-srp-browserstack-url: ${{ steps.browserstack-upload.outputs.without-srp-browserstack-url }}
      with-srp-app-id: ${{ steps.browserstack-upload.outputs.with-srp-app-id }}
      without-srp-app-id: ${{ steps.browserstack-upload.outputs.without-srp-app-id }}
      with-srp-version: ${{ steps.browserstack-upload.outputs.with-srp-version }}
      without-srp-version: ${{ steps.browserstack-upload.outputs.without-srp-version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download with-SRP IPA artifact
        if: needs.build-ios-with-srp.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: metamask-ios-with-srp-ipa
          path: ./artifacts/with-srp

      - name: Download without-SRP IPA artifact
        if: needs.build-ios-without-srp.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: metamask-ios-without-srp-ipa
          path: ./artifacts/without-srp
            
      - name: Upload IPAs to BrowserStack
        id: browserstack-upload
        run: |
          echo "Uploading IPAs to BrowserStack..."
          
          # Initialize upload status outputs
          {
            echo "with-srp-ipa-uploaded=false"
            echo "without-srp-ipa-uploaded=false"
          } >> "$GITHUB_OUTPUT"
          
          # Upload with-SRP IPA
          if [ -f "./artifacts/with-srp/metamask-ios-with-srp.ipa" ]; then
            echo "üì§ Uploading with-SRP IPA to BrowserStack..."
            WITH_SRP_RESPONSE=$(curl -u "$BROWSERSTACK_USERNAME:$BROWSERSTACK_ACCESS_KEY" \
              -X POST "https://api-cloud.browserstack.com/app-automate/upload" \
              -F "file=@./artifacts/with-srp/metamask-ios-with-srp.ipa" \
              -F "custom_id=MetaMask-iOS-With-SRP-${{ github.run_id }}")
            
            WITH_SRP_APP_URL=$(echo "$WITH_SRP_RESPONSE" | jq -r '.app_url')
            WITH_SRP_APP_ID=$(echo "$WITH_SRP_RESPONSE" | jq -r '.app_id')
            
            if [ "$WITH_SRP_APP_URL" != "null" ] && [ -n "$WITH_SRP_APP_URL" ]; then
              echo "‚úÖ With-SRP IPA uploaded successfully"
              echo "  App URL: $WITH_SRP_APP_URL"
              echo "  App ID: $WITH_SRP_APP_ID"
              
              {
                echo "with-srp-browserstack-url=$WITH_SRP_APP_URL"
                echo "with-srp-app-id=$WITH_SRP_APP_ID"
                echo "with-srp-version=GitHub-Actions-Build"
                echo "with-srp-ipa-uploaded=true"
              } >> "$GITHUB_OUTPUT"
            else
              echo "‚ùå Failed to upload with-SRP IPA"
              echo "Response: $WITH_SRP_RESPONSE"
            fi
          else
            echo "‚ö†Ô∏è With-SRP IPA not found"
          fi
          
          # Upload without-SRP IPA
          if [ -f "./artifacts/without-srp/metamask-ios-without-srp.ipa" ]; then
            echo "üì§ Uploading without-SRP IPA to BrowserStack..."
            WITHOUT_SRP_RESPONSE=$(curl -u "$BROWSERSTACK_USERNAME:$BROWSERSTACK_ACCESS_KEY" \
              -X POST "https://api-cloud.browserstack.com/app-automate/upload" \
              -F "file=@./artifacts/without-srp/metamask-ios-without-srp.ipa" \
              -F "custom_id=MetaMask-iOS-Without-SRP-${{ github.run_id }}")
            
            WITHOUT_SRP_APP_URL=$(echo "$WITHOUT_SRP_RESPONSE" | jq -r '.app_url')
            WITHOUT_SRP_APP_ID=$(echo "$WITHOUT_SRP_RESPONSE" | jq -r '.app_id')
            
            if [ "$WITHOUT_SRP_APP_URL" != "null" ] && [ -n "$WITHOUT_SRP_APP_URL" ]; then
              echo "‚úÖ Without-SRP IPA uploaded successfully"
              echo "  App URL: $WITHOUT_SRP_APP_URL"
              echo "  App ID: $WITHOUT_SRP_APP_ID"
              
              {
                echo "without-srp-browserstack-url=$WITHOUT_SRP_APP_URL"
                echo "without-srp-app-id=$WITHOUT_SRP_APP_ID"
                echo "without-srp-version=GitHub-Actions-Build"
                echo "without-srp-ipa-uploaded=true"
              } >> "$GITHUB_OUTPUT"
            else
              echo "‚ùå Failed to upload without-SRP IPA"
              echo "Response: $WITHOUT_SRP_RESPONSE"
            fi
          else
            echo "‚ö†Ô∏è Without-SRP IPA not found"
          fi
          
          echo ""
          echo "üìä BrowserStack upload process completed!"
          echo "With-SRP URL: ${WITH_SRP_APP_URL:-'Not uploaded'}"
          echo "Without-SRP URL: ${WITHOUT_SRP_APP_URL:-'Not uploaded'}"
