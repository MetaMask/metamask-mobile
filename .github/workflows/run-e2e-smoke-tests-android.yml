name: Android E2E Smoke Tests

on:
  workflow_call:
    inputs:
      selected_tags:
        description: 'JSON array of selected tags from Smart E2E selection (e.g., ["SmokeAccounts", "SmokeTrade"])'
        required: false
        type: string
        default: '["ALL"]'
      changed_files:
        description: 'Changed files'
        required: false
        type: string
        default: ''

permissions:
  contents: read
  id-token: write

jobs:
  trade-android-smoke:
    if: contains(fromJson(inputs.selected_tags), 'ALL') || contains(fromJson(inputs.selected_tags), 'SmokeTrade')
    strategy:
      matrix:
        split: [1]
      fail-fast: false
    uses: ./.github/workflows/run-e2e-workflow.yml
    with:
      test-suite-name: trade-android-smoke-${{ matrix.split }}
      platform: android
      test_suite_tag: 'SmokeTrade'
      split_number: ${{ matrix.split }}
      total_splits: 1
      changed_files: ${{ inputs.changed_files }}
    secrets: inherit

  perps-android-smoke:
    if: contains(fromJson(inputs.selected_tags), 'ALL') || contains(fromJson(inputs.selected_tags), 'SmokePerps')
    strategy:
      matrix:
        split: [1]
      fail-fast: false
    uses: ./.github/workflows/run-e2e-workflow.yml
    with:
      test-suite-name: perps-android-smoke-${{ matrix.split }}
      platform: android
      test_suite_tag: 'SmokePerps'
      split_number: ${{ matrix.split }}
      total_splits: 1
      changed_files: ${{ inputs.changed_files }}
    secrets: inherit

  wallet-platform-android-smoke:
    if: contains(fromJson(inputs.selected_tags), 'ALL') || contains(fromJson(inputs.selected_tags), 'SmokeWalletPlatform')
    strategy:
      matrix:
        split: [1, 2]
      fail-fast: false
    uses: ./.github/workflows/run-e2e-workflow.yml
    with:
      test-suite-name: wallet-platform-android-smoke-${{ matrix.split }}
      platform: android
      test_suite_tag: 'SmokeWalletPlatform'
      split_number: ${{ matrix.split }}
      total_splits: 2
      changed_files: ${{ inputs.changed_files }}
    secrets: inherit

  identity-android-smoke:
    if: contains(fromJson(inputs.selected_tags), 'ALL') || contains(fromJson(inputs.selected_tags), 'SmokeIdentity')
    strategy:
      matrix:
        split: [1, 2]
      fail-fast: false
    uses: ./.github/workflows/run-e2e-workflow.yml
    with:
      test-suite-name: identity-android-smoke-${{ matrix.split }}
      platform: android
      test_suite_tag: 'SmokeIdentity'
      split_number: ${{ matrix.split }}
      total_splits: 2
      changed_files: ${{ inputs.changed_files }}
    secrets: inherit

  accounts-android-smoke:
    if: contains(fromJson(inputs.selected_tags), 'ALL') || contains(fromJson(inputs.selected_tags), 'SmokeAccounts')
    strategy:
      matrix:
        split: [1]
      fail-fast: false
    uses: ./.github/workflows/run-e2e-workflow.yml
    with:
      test-suite-name: accounts-android-smoke-${{ matrix.split }}
      platform: android
      test_suite_tag: 'SmokeAccounts'
      split_number: ${{ matrix.split }}
      total_splits: 1
      changed_files: ${{ inputs.changed_files }}
    secrets: inherit

  network-abstraction-android-smoke:
    if: contains(fromJson(inputs.selected_tags), 'ALL') || contains(fromJson(inputs.selected_tags), 'SmokeNetworkAbstractions')
    strategy:
      matrix:
        split: [1, 2]
      fail-fast: false
    uses: ./.github/workflows/run-e2e-workflow.yml
    with:
      test-suite-name: network-abstraction-android-smoke-${{ matrix.split }}
      platform: android
      test_suite_tag: 'SmokeNetworkAbstractions'
      split_number: ${{ matrix.split }}
      total_splits: 2
      changed_files: ${{ inputs.changed_files }}
    secrets: inherit

  network-expansion-android-smoke:
    if: contains(fromJson(inputs.selected_tags), 'ALL') || contains(fromJson(inputs.selected_tags), 'SmokeNetworkExpansion')
    strategy:
      matrix:
        split: [1, 2]
      fail-fast: false
    uses: ./.github/workflows/run-e2e-workflow.yml
    with:
      test-suite-name: network-expansion-android-smoke-${{ matrix.split }}
      platform: android
      test_suite_tag: 'SmokeNetworkExpansion'
      split_number: ${{ matrix.split }}
      total_splits: 2
      changed_files: ${{ inputs.changed_files }}
    secrets: inherit

  confirmations-redesigned-android-smoke:
    if: contains(fromJson(inputs.selected_tags), 'ALL') || contains(fromJson(inputs.selected_tags), 'SmokeConfirmationsRedesigned')
    strategy:
      matrix:
        split: [1, 2, 3]
      fail-fast: false
    uses: ./.github/workflows/run-e2e-workflow.yml
    with:
      test-suite-name: confirmations-redesigned-android-smoke-${{ matrix.split }}
      platform: android
      test_suite_tag: 'SmokeConfirmationsRedesigned'
      split_number: ${{ matrix.split }}
      total_splits: 3
      changed_files: ${{ inputs.changed_files }}
    secrets: inherit

  prediction-market-android-smoke:
    if: contains(fromJson(inputs.selected_tags), 'ALL') || contains(fromJson(inputs.selected_tags), 'SmokePredictions')
    strategy:
      matrix:
        split: [1]
      fail-fast: false
    uses: ./.github/workflows/run-e2e-workflow.yml
    with:
      test-suite-name: prediction-market-android-smoke-${{ matrix.split }}
      platform: android
      test_suite_tag: 'SmokePredictions'
      split_number: ${{ matrix.split }}
      total_splits: 1
      changed_files: ${{ inputs.changed_files }}
    secrets: inherit

  rewards-android-smoke:
    if: contains(fromJson(inputs.selected_tags), 'ALL') || contains(fromJson(inputs.selected_tags), 'SmokeRewards')
    strategy:
      matrix:
        split: [1]
      fail-fast: false
    uses: ./.github/workflows/run-e2e-workflow.yml
    with:
      test-suite-name: rewards-android-smoke-${{ matrix.split }}
      platform: android
      test_suite_tag: 'SmokeRewards'
      split_number: ${{ matrix.split }}
      total_splits: 1
      changed_files: ${{ inputs.changed_files }}
    secrets: inherit

  card-android-smoke:
    if: contains(fromJson(inputs.selected_tags), 'ALL') || contains(fromJson(inputs.selected_tags), 'SmokeCard')
    strategy:
      matrix:
        split: [1]
      fail-fast: false
    uses: ./.github/workflows/run-e2e-workflow.yml
    with:
      test-suite-name: card-android-smoke-${{ matrix.split }}
      platform: android
      test_suite_tag: 'SmokeCard'
      split_number: ${{ matrix.split }}
      total_splits: 1
      changed_files: ${{ inputs.changed_files }}
    secrets: inherit

  ramps-android-smoke:
    if: contains(fromJson(inputs.selected_tags), 'ALL') || contains(fromJson(inputs.selected_tags), 'SmokeRamps')
    strategy:
      matrix:
        split: [1]
      fail-fast: false
    uses: ./.github/workflows/run-e2e-workflow.yml
    with:
      test-suite-name: ramps-android-smoke-${{ matrix.split }}
      platform: android
      test_suite_tag: 'SmokeRamps'
      split_number: ${{ matrix.split }}
      total_splits: 1
      changed_files: ${{ inputs.changed_files }}
    secrets: inherit

  multichain-api-android-smoke:
    if: contains(fromJson(inputs.selected_tags), 'ALL') || contains(fromJson(inputs.selected_tags), 'SmokeMultiChainAPI')
    strategy:
      matrix:
        split: [1]
      fail-fast: false
    uses: ./.github/workflows/run-e2e-workflow.yml
    with:
      test-suite-name: multichain-api-android-smoke-${{ matrix.split }}
      platform: android
      test_suite_tag: 'SmokeMultiChainAPI'
      split_number: ${{ matrix.split }}
      total_splits: 1
      changed_files: ${{ inputs.changed_files }}
    secrets: inherit

  report-android-smoke-tests:
    name: Report Android Smoke Tests
    runs-on: ubuntu-latest
    if: ${{ !cancelled() && inputs.selected_tags != '[]' && inputs.selected_tags != '["FlaskBuildTests"]' }}
    needs:
      - trade-android-smoke
      - perps-android-smoke
      - wallet-platform-android-smoke
      - identity-android-smoke
      - accounts-android-smoke
      - network-abstraction-android-smoke
      - network-expansion-android-smoke
      - confirmations-redesigned-android-smoke
      - prediction-market-android-smoke
      - rewards-android-smoke
      - card-android-smoke
      - ramps-android-smoke
      - multichain-api-android-smoke
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Download shards test artifacts (XMLs + Screenshots)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          path: all-test-artifacts/
          pattern: 'test-e2e-*-android-*'

      - name: Post Test Report
        uses: dorny/test-reporter@dc3a92680fcc15842eef52e8c4606ea7ce6bd3f3
        with:
          name: 'Android E2E Smoke Test Results'
          path: 'all-test-artifacts/**/junit.xml'
          reporter: 'jest-junit'
          fail-on-error: false
          list-suites: 'failed'
          list-tests: 'failed'

      - name: Upload all test artifacts (XMLs + Screenshots)
        uses: actions/upload-artifact@v4
        with:
          name: e2e-smoke-android-all-test-artifacts
          path: all-test-artifacts/

      - name: Create mobile JSON test report
        id: create-json-report
        continue-on-error: true
        run: |
          # Create a temporary directory for xml2js to avoid conflicts
          mkdir -p temp-deps && cd temp-deps
          npm init -y
          npm install xml2js@0.5.0 --no-audit --no-fund

          # Copy node_modules to workspace
          cp -r node_modules ${{ github.workspace }}/

          # Run the mobile test report generator
          cd ${{ github.workspace }}
          TEST_RESULTS_PATH=all-test-artifacts \
          TEST_RUNS_PATH=test/test-results/test-runs-android.json \
          RUN_ID=${{ github.run_id }} \
          PR_NUMBER=${{ github.event.pull_request.number || '0' }} \
          GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }} \
          node .github/scripts/e2e-create-json-test-report.mjs

          # Clean up temporary node_modules
          rm -rf node_modules

      - name: Upload JSON test report
        if: steps.create-json-report.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: test-e2e-android-json-report
          path: test/test-results/test-runs-android.json
