# This workflow creates two non E2E Android Builds and uploads to BrowserStack
# Build 1: With ADDITIONAL_SRP_1 and PREDEFINED_PASSWORD (pre-imported wallet)
# Build 2: Without these environment variables (fresh wallet)
# Both builds run on GitHub Actions runners (migrated from Bitrise)

name: Build Android Dual Versions and Upload to BrowserStack

on:
  workflow_call:
    inputs:
      browserstack_app_url_android_onboarding:
        required: false
        type: string
        description: 'BrowserStack Android Onboarding App URL (bs://...)'
      browserstack_app_url_android_imported_wallet:
        required: false
        type: string
        description: 'BrowserStack Android Imported Wallet App URL (bs://...)'
    outputs:
      with-srp-browserstack-url:
        description: 'BrowserStack URL for with-SRP version'
        value: ${{ jobs.upload-to-browserstack.outputs.with-srp-browserstack-url }}
      without-srp-browserstack-url:
        description: 'BrowserStack URL for without-SRP version'
        value: ${{ jobs.upload-to-browserstack.outputs.without-srp-browserstack-url }}
      with-srp-app-id:
        description: 'BrowserStack App ID for with-SRP version'
        value: ${{ jobs.upload-to-browserstack.outputs.with-srp-app-id }}
      without-srp-app-id:
        description: 'BrowserStack App ID for without-SRP version'
        value: ${{ jobs.upload-to-browserstack.outputs.without-srp-app-id }}
      with-srp-version:
        description: 'App version for with-SRP build'
        value: ${{ jobs.upload-to-browserstack.outputs.with-srp-version }}
      without-srp-version:
        description: 'App version for without-SRP build'
        value: ${{ jobs.upload-to-browserstack.outputs.without-srp-version }}
  workflow_dispatch:
    inputs:
      description:
        description: 'Optional description for this build run'
        required: false
        type: string

permissions:
  contents: read
  id-token: write

env:
  BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
  BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}

jobs:
  check-builds-needed:
    name: Check if Android builds are needed
    runs-on: ubuntu-latest
    outputs:
      builds-needed: ${{ steps.check-builds.outputs.builds-needed }}

    steps:
      - name: Check if builds are needed
        id: check-builds
        run: |
          # Check if any BS URLs are provided via workflow inputs
          if [ -n "${{ inputs.browserstack_app_url_android_onboarding }}" ] || [ -n "${{ inputs.browserstack_app_url_android_imported_wallet }}" ]; then
            echo "builds-needed=false" >> "$GITHUB_OUTPUT"
            echo "Skipping Android builds - BS URLs provided via workflow inputs"
          else
            echo "builds-needed=true" >> "$GITHUB_OUTPUT"
            echo "Android builds needed - no BS URLs provided"
          fi

  build-android-with-srp:
    name: Build Android with-SRP
    runs-on: ghcr.io/cirruslabs/ubuntu-runner-amd64:24.04-xl
    needs: [check-builds-needed]
    if: needs.check-builds-needed.outputs.builds-needed == 'true'
    timeout-minutes: 45
    outputs:
      build-success: ${{ steps.build-apk.outcome == 'success' }}
    env:
      GRADLE_USER_HOME: /home/admin/_work/.gradle
      GITHUB_CI: 'true'
      PLATFORM: android
      METAMASK_ENVIRONMENT: rc
      METAMASK_BUILD_TYPE: main
      CI: 'true'
      NODE_OPTIONS: '--max-old-space-size=8192'
      # Environment variables for with-SRP build
      ADDITIONAL_SRP_1: ${{ secrets.IN_BUILD_SRP }}
      PREDEFINED_PASSWORD: ${{ secrets.E2E_PASSWORD }}
      DISABLE_NOTIFICATION_PROMPT: 'true'
      # Build secrets
      SEGMENT_WRITE_KEY_QA: ${{ secrets.SEGMENT_WRITE_KEY_QA }}
      SEGMENT_PROXY_URL_QA: ${{ secrets.SEGMENT_PROXY_URL_QA }}
      SEGMENT_DELETE_API_SOURCE_ID_QA: ${{ secrets.SEGMENT_DELETE_API_SOURCE_ID_QA }}
      SEGMENT_REGULATIONS_ENDPOINT_QA: ${{ secrets.SEGMENT_REGULATIONS_ENDPOINT_QA }}
      MM_SENTRY_DSN_TEST: ${{ secrets.MM_SENTRY_DSN_TEST }}
      MM_SENTRY_AUTH_TOKEN: ${{ secrets.MM_SENTRY_AUTH_TOKEN }}
      MAIN_IOS_GOOGLE_CLIENT_ID_PROD: ${{ secrets.MAIN_IOS_GOOGLE_CLIENT_ID_PROD }}
      MAIN_IOS_GOOGLE_REDIRECT_URI_PROD: ${{ secrets.MAIN_IOS_GOOGLE_REDIRECT_URI_PROD }}
      MAIN_ANDROID_APPLE_CLIENT_ID_PROD: ${{ secrets.MAIN_ANDROID_APPLE_CLIENT_ID_PROD }}
      MAIN_ANDROID_GOOGLE_CLIENT_ID_PROD: ${{ secrets.MAIN_ANDROID_GOOGLE_CLIENT_ID_PROD }}
      MAIN_ANDROID_GOOGLE_SERVER_CLIENT_ID_PROD: ${{ secrets.MAIN_ANDROID_GOOGLE_SERVER_CLIENT_ID_PROD }}
      GOOGLE_SERVICES_B64_IOS: ${{ secrets.GOOGLE_SERVICES_B64_IOS }}
      GOOGLE_SERVICES_B64_ANDROID: ${{ secrets.GOOGLE_SERVICES_B64_ANDROID }}
      MM_INFURA_PROJECT_ID: ${{ secrets.MM_INFURA_PROJECT_ID }}
      FEATURES_ANNOUNCEMENTS_ACCESS_TOKEN: ${{ secrets.FEATURES_ANNOUNCEMENTS_ACCESS_TOKEN }}
      FEATURES_ANNOUNCEMENTS_SPACE_ID: ${{ secrets.FEATURES_ANNOUNCEMENTS_SPACE_ID }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Android Build Environment
        uses: MetaMask/github-tools/.github/actions/setup-e2e-env@v1
        with:
          platform: android
          setup-simulator: false
          configure-keystores: true
          target: qa

      - name: Print Android tool versions
        run: |
          echo "üîß Node.js Version:"
          node -v || echo "Node not found"
          echo "üß∂ Yarn Version:"
          yarn -v || echo "Yarn not found"
          echo "üì¶ Java Version:"
          java -version 2>&1 || echo "Java not found"
          echo "ü§ñ Android SDK:"
          echo $ANDROID_SDK_ROOT || echo "ANDROID_SDK_ROOT not set"
        shell: bash

      - name: Cache Gradle dependencies
        uses: cirruslabs/cache@v4
        env:
          GRADLE_CACHE_VERSION: 1
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            /home/admin/_work/.gradle/caches
            /home/admin/_work/.gradle/wrapper
          key: gradle-${{ env.GRADLE_CACHE_VERSION }}-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

      - name: Setup project dependencies with retry
        uses: nick-fields/retry@ce71cc2ab81d554ebbe88c79ab5975992d79ba08 #v3.0.2
        with:
          timeout_minutes: 15
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            echo "üöÄ Setting up project..."
            yarn setup:github-ci --no-build-ios

      - name: Build Android APK (Release)
        id: build-apk
        run: |
          echo "üèó Building Android APK..."
          export NODE_OPTIONS="--max-old-space-size=8192"
          # Use GitHub CI gradle properties
          cp android/gradle.properties.github android/gradle.properties 2>/dev/null || true
          yarn build:android:main:rc
        shell: bash
        env:
          PLATFORM: android
          METAMASK_ENVIRONMENT: rc
          METAMASK_BUILD_TYPE: main
          CONFIGURATION: Release
          ADDITIONAL_SRP_1: ${{ secrets.IN_BUILD_SRP }}
          PREDEFINED_PASSWORD: ${{ secrets.E2E_PASSWORD }}
          DISABLE_NOTIFICATION_PROMPT: 'true'

      - name: Find and rename APK
        id: find-apk
        run: |
          echo "üì¶ Looking for APK file..."
          # Find the APK in the build output directory
          APK_PATH=$(find android/app/build/outputs/apk -name "*.apk" -type f ! -name "*-androidTest.apk" 2>/dev/null | head -1)
          
          if [ -z "$APK_PATH" ]; then
            echo "‚ùå No APK found in android/app/build/outputs/apk"
            find android -name "*.apk" -type f 2>/dev/null || echo "No APK files found anywhere"
            exit 1
          fi
          
          echo "‚úÖ Found APK: $APK_PATH"
          
          # Copy to a standard name for artifact upload
          mkdir -p android/build/output
          cp "$APK_PATH" "android/build/output/metamask-android-with-srp.apk"
          echo "apk-path=android/build/output/metamask-android-with-srp.apk" >> "$GITHUB_OUTPUT"
          
          # Get file size
          du -h "android/build/output/metamask-android-with-srp.apk"

      - name: Upload Android APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: metamask-android-with-srp-apk
          path: android/build/output/metamask-android-with-srp.apk
          retention-days: 7
          if-no-files-found: error

  build-android-without-srp:
    name: Build Android without-SRP
    runs-on: ghcr.io/cirruslabs/ubuntu-runner-amd64:24.04-xl
    needs: [check-builds-needed]
    if: needs.check-builds-needed.outputs.builds-needed == 'true'
    timeout-minutes: 45
    outputs:
      build-success: ${{ steps.build-apk.outcome == 'success' }}
    env:
      GRADLE_USER_HOME: /home/admin/_work/.gradle
      GITHUB_CI: 'true'
      PLATFORM: android
      METAMASK_ENVIRONMENT: rc
      METAMASK_BUILD_TYPE: main
      CI: 'true'
      NODE_OPTIONS: '--max-old-space-size=8192'
      # Environment variables for without-SRP build (no ADDITIONAL_SRP_1 or PREDEFINED_PASSWORD)
      DISABLE_NOTIFICATION_PROMPT: 'true'
      # Build secrets
      SEGMENT_WRITE_KEY_QA: ${{ secrets.SEGMENT_WRITE_KEY_QA }}
      SEGMENT_PROXY_URL_QA: ${{ secrets.SEGMENT_PROXY_URL_QA }}
      SEGMENT_DELETE_API_SOURCE_ID_QA: ${{ secrets.SEGMENT_DELETE_API_SOURCE_ID_QA }}
      SEGMENT_REGULATIONS_ENDPOINT_QA: ${{ secrets.SEGMENT_REGULATIONS_ENDPOINT_QA }}
      MM_SENTRY_DSN_TEST: ${{ secrets.MM_SENTRY_DSN_TEST }}
      MM_SENTRY_AUTH_TOKEN: ${{ secrets.MM_SENTRY_AUTH_TOKEN }}
      MAIN_IOS_GOOGLE_CLIENT_ID_PROD: ${{ secrets.MAIN_IOS_GOOGLE_CLIENT_ID_PROD }}
      MAIN_IOS_GOOGLE_REDIRECT_URI_PROD: ${{ secrets.MAIN_IOS_GOOGLE_REDIRECT_URI_PROD }}
      MAIN_ANDROID_APPLE_CLIENT_ID_PROD: ${{ secrets.MAIN_ANDROID_APPLE_CLIENT_ID_PROD }}
      MAIN_ANDROID_GOOGLE_CLIENT_ID_PROD: ${{ secrets.MAIN_ANDROID_GOOGLE_CLIENT_ID_PROD }}
      MAIN_ANDROID_GOOGLE_SERVER_CLIENT_ID_PROD: ${{ secrets.MAIN_ANDROID_GOOGLE_SERVER_CLIENT_ID_PROD }}
      GOOGLE_SERVICES_B64_IOS: ${{ secrets.GOOGLE_SERVICES_B64_IOS }}
      GOOGLE_SERVICES_B64_ANDROID: ${{ secrets.GOOGLE_SERVICES_B64_ANDROID }}
      MM_INFURA_PROJECT_ID: ${{ secrets.MM_INFURA_PROJECT_ID }}
      FEATURES_ANNOUNCEMENTS_ACCESS_TOKEN: ${{ secrets.FEATURES_ANNOUNCEMENTS_ACCESS_TOKEN }}
      FEATURES_ANNOUNCEMENTS_SPACE_ID: ${{ secrets.FEATURES_ANNOUNCEMENTS_SPACE_ID }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Android Build Environment
        uses: MetaMask/github-tools/.github/actions/setup-e2e-env@v1
        with:
          platform: android
          setup-simulator: false
          configure-keystores: true
          target: qa

      - name: Print Android tool versions
        run: |
          echo "üîß Node.js Version:"
          node -v || echo "Node not found"
          echo "üß∂ Yarn Version:"
          yarn -v || echo "Yarn not found"
          echo "üì¶ Java Version:"
          java -version 2>&1 || echo "Java not found"
          echo "ü§ñ Android SDK:"
          echo $ANDROID_SDK_ROOT || echo "ANDROID_SDK_ROOT not set"
        shell: bash

      - name: Cache Gradle dependencies
        uses: cirruslabs/cache@v4
        env:
          GRADLE_CACHE_VERSION: 1
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            /home/admin/_work/.gradle/caches
            /home/admin/_work/.gradle/wrapper
          key: gradle-${{ env.GRADLE_CACHE_VERSION }}-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

      - name: Setup project dependencies with retry
        uses: nick-fields/retry@ce71cc2ab81d554ebbe88c79ab5975992d79ba08 #v3.0.2
        with:
          timeout_minutes: 15
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            echo "üöÄ Setting up project..."
            yarn setup:github-ci --no-build-ios

      - name: Build Android APK (Release)
        id: build-apk
        run: |
          echo "üèó Building Android APK..."
          export NODE_OPTIONS="--max-old-space-size=8192"
          # Use GitHub CI gradle properties
          cp android/gradle.properties.github android/gradle.properties 2>/dev/null || true
          yarn build:android:main:rc
        shell: bash
        env:
          PLATFORM: android
          METAMASK_ENVIRONMENT: rc
          METAMASK_BUILD_TYPE: main
          CONFIGURATION: Release
          DISABLE_NOTIFICATION_PROMPT: 'true'

      - name: Find and rename APK
        id: find-apk
        run: |
          echo "üì¶ Looking for APK file..."
          # Find the APK in the build output directory
          APK_PATH=$(find android/app/build/outputs/apk -name "*.apk" -type f ! -name "*-androidTest.apk" 2>/dev/null | head -1)
          
          if [ -z "$APK_PATH" ]; then
            echo "‚ùå No APK found in android/app/build/outputs/apk"
            find android -name "*.apk" -type f 2>/dev/null || echo "No APK files found anywhere"
            exit 1
          fi
          
          echo "‚úÖ Found APK: $APK_PATH"
          
          # Copy to a standard name for artifact upload
          mkdir -p android/build/output
          cp "$APK_PATH" "android/build/output/metamask-android-without-srp.apk"
          echo "apk-path=android/build/output/metamask-android-without-srp.apk" >> "$GITHUB_OUTPUT"
          
          # Get file size
          du -h "android/build/output/metamask-android-without-srp.apk"

      - name: Upload Android APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: metamask-android-without-srp-apk
          path: android/build/output/metamask-android-without-srp.apk
          retention-days: 7
          if-no-files-found: error

  upload-to-browserstack:
    name: Upload APKs to BrowserStack
    runs-on: ubuntu-latest
    needs: [check-builds-needed, build-android-with-srp, build-android-without-srp]
    if: |
      always() && 
      needs.check-builds-needed.outputs.builds-needed == 'true' &&
      (needs.build-android-with-srp.result == 'success' || needs.build-android-without-srp.result == 'success')
    outputs:
      with-srp-browserstack-url: ${{ steps.browserstack-upload.outputs.with-srp-browserstack-url }}
      without-srp-browserstack-url: ${{ steps.browserstack-upload.outputs.without-srp-browserstack-url }}
      with-srp-app-id: ${{ steps.browserstack-upload.outputs.with-srp-app-id }}
      without-srp-app-id: ${{ steps.browserstack-upload.outputs.without-srp-app-id }}
      with-srp-version: ${{ steps.browserstack-upload.outputs.with-srp-version }}
      without-srp-version: ${{ steps.browserstack-upload.outputs.without-srp-version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download with-SRP APK artifact
        if: needs.build-android-with-srp.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: metamask-android-with-srp-apk
          path: ./artifacts/with-srp

      - name: Download without-SRP APK artifact
        if: needs.build-android-without-srp.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: metamask-android-without-srp-apk
          path: ./artifacts/without-srp
            
      - name: Upload APKs to BrowserStack
        id: browserstack-upload
        run: |
          echo "Uploading APKs to BrowserStack..."
          
          # Initialize upload status outputs
          {
            echo "with-srp-apk-uploaded=false"
            echo "without-srp-apk-uploaded=false"
          } >> "$GITHUB_OUTPUT"
          
          # Upload with-SRP APK
          if [ -f "./artifacts/with-srp/metamask-android-with-srp.apk" ]; then
            echo "üì§ Uploading with-SRP APK to BrowserStack..."
            echo "File size: $(du -h ./artifacts/with-srp/metamask-android-with-srp.apk | cut -f1)"
            
            WITH_SRP_RESPONSE=$(curl -u "$BROWSERSTACK_USERNAME:$BROWSERSTACK_ACCESS_KEY" \
              -X POST "https://api-cloud.browserstack.com/app-automate/upload" \
              -F "file=@./artifacts/with-srp/metamask-android-with-srp.apk" \
              -F "custom_id=MetaMask-Android-With-SRP-${{ github.run_id }}")
            
            WITH_SRP_APP_URL=$(echo "$WITH_SRP_RESPONSE" | jq -r '.app_url')
            WITH_SRP_APP_ID=$(echo "$WITH_SRP_RESPONSE" | jq -r '.app_id')
            
            if [ "$WITH_SRP_APP_URL" != "null" ] && [ -n "$WITH_SRP_APP_URL" ]; then
              echo "‚úÖ With-SRP APK uploaded successfully"
              echo "  App URL: $WITH_SRP_APP_URL"
              echo "  App ID: $WITH_SRP_APP_ID"
              
              {
                echo "with-srp-browserstack-url=$WITH_SRP_APP_URL"
                echo "with-srp-app-id=$WITH_SRP_APP_ID"
                echo "with-srp-version=GitHub-Actions-Build"
                echo "with-srp-apk-uploaded=true"
              } >> "$GITHUB_OUTPUT"
            else
              echo "‚ùå Failed to upload with-SRP APK"
              echo "Response: $WITH_SRP_RESPONSE"
            fi
          else
            echo "‚ö†Ô∏è With-SRP APK not found"
          fi
          
          # Upload without-SRP APK
          if [ -f "./artifacts/without-srp/metamask-android-without-srp.apk" ]; then
            echo "üì§ Uploading without-SRP APK to BrowserStack..."
            echo "File size: $(du -h ./artifacts/without-srp/metamask-android-without-srp.apk | cut -f1)"
            
            WITHOUT_SRP_RESPONSE=$(curl -u "$BROWSERSTACK_USERNAME:$BROWSERSTACK_ACCESS_KEY" \
              -X POST "https://api-cloud.browserstack.com/app-automate/upload" \
              -F "file=@./artifacts/without-srp/metamask-android-without-srp.apk" \
              -F "custom_id=MetaMask-Android-Without-SRP-${{ github.run_id }}")
            
            WITHOUT_SRP_APP_URL=$(echo "$WITHOUT_SRP_RESPONSE" | jq -r '.app_url')
            WITHOUT_SRP_APP_ID=$(echo "$WITHOUT_SRP_RESPONSE" | jq -r '.app_id')
            
            if [ "$WITHOUT_SRP_APP_URL" != "null" ] && [ -n "$WITHOUT_SRP_APP_URL" ]; then
              echo "‚úÖ Without-SRP APK uploaded successfully"
              echo "  App URL: $WITHOUT_SRP_APP_URL"
              echo "  App ID: $WITHOUT_SRP_APP_ID"
              
              {
                echo "without-srp-browserstack-url=$WITHOUT_SRP_APP_URL"
                echo "without-srp-app-id=$WITHOUT_SRP_APP_ID"
                echo "without-srp-version=GitHub-Actions-Build"
                echo "without-srp-apk-uploaded=true"
              } >> "$GITHUB_OUTPUT"
            else
              echo "‚ùå Failed to upload without-SRP APK"
              echo "Response: $WITHOUT_SRP_RESPONSE"
            fi
          else
            echo "‚ö†Ô∏è Without-SRP APK not found"
          fi
          
          echo ""
          echo "üìä BrowserStack upload process completed!"
          echo "With-SRP URL: ${WITH_SRP_APP_URL:-'Not uploaded'}"
          echo "Without-SRP URL: ${WITHOUT_SRP_APP_URL:-'Not uploaded'}"
