# This workflow runs mobile E2E tests for a specific smoke test category.
# It passes matrix sharding info to the test framework via environment variables.

name: Test Mobile E2E Category

on:
  workflow_call:
    inputs:
      test-suite-name:
        description: 'Name of the test suite'
        required: true
        type: string
      smoke-category:
        description: 'Smoke test category (confirmations, trade, wallet-platform, etc.)'
        required: true
        type: string
      platform:
        description: 'Platform to test (ios or android)'
        required: true
        type: string
      test_suite_tag:
        description: 'The Cucumber tag expression to use for filtering tests'
        required: false
        type: string
      is_api_specs:
        description: 'Whether this is the API specs test (iOS-only, special command)'
        required: false
        type: boolean
        default: false
      use_prebuilt_apps:
        description: 'Use pre-built apps from GitHub release instead of building'
        required: false
        type: boolean
        default: false

jobs:
  test-e2e-mobile:
    name: ${{ inputs.test-suite-name }}
    runs-on: ${{ inputs.platform == 'ios' && 'macos-latest-xlarge' || 'large-mm-test' }}
    env:
      METAMASK_ENVIRONMENT: 'local'
      METAMASK_BUILD_TYPE: 'main'
      SMOKE_CATEGORY: ${{ inputs.smoke-category }}
      TEST_SUITE_TAG: ${{ inputs.test_suite_tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Enable KVM group perms (Ubuntu only)
        if: inputs.platform == 'android'
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Set up E2E environment
        uses: MetaMask/github-tools/.github/actions/setup-e2e-env@emulator-configs
        with:
          platform: ${{ inputs.platform }}
          setup-simulator: ${{ inputs.platform == 'ios' }}
          android-avd-name: emulator
          android-abi: x86_64

      # test workadound
      - name: Build Detox framework cache (iOS)
        if: ${{ inputs.platform == 'ios' }}
        run: |
          echo "Building Detox framework cache for iOS..."
          yarn detox clean-framework-cache
          yarn detox build-framework-cache

      #- name: Build E2E app
      #  if: ${{ !inputs.use_prebuilt_apps }}
      #  run: |
      #    platform="${{ inputs.platform }}"
      #
      #    # Set environment variables for build
      #    export METAMASK_ENVIRONMENT='local'
      #    export METAMASK_BUILD_TYPE='main'
      #    export IS_TEST='true'
      #    export IGNORE_BOXLOGS_DEVELOPMENT="true"
      #
      #    echo "Building E2E app for $platform..."
      #
      #    if [[ "$platform" == "ios" ]]; then
      #      yarn test:e2e:ios:build:qa-release
      #    else
      #      yarn test:e2e:android:build:qa-release
      #    fi

      - name: Setup pre-built apps from GitHub release
        if: ${{ inputs.use_prebuilt_apps }}
        run: |
          platform="${{ inputs.platform }}"

          echo "ðŸš€ Setting up pre-built apps for $platform..."

          # Base URL for artifacts
          base_url="https://github.com/MetaMask/tmp-bitrise-migration-artifacts/releases/download/test2"

          # Create required directories
          mkdir -p android/app/build/outputs/apk/qa/release/
          mkdir -p ios/build/Build/Products/Release-iphonesimulator/

          if [[ "$platform" == "ios" ]]; then
            echo "ðŸ“¥ Downloading iOS artifacts..."

            # Clean up any existing lock files
            find . -name "*.lock" -type f -delete 2>/dev/null || true

            # Download Release-iphonesimulator.zip
            if curl -L --fail -o /tmp/Release-iphonesimulator.zip "${base_url}/Release-iphonesimulator.zip"; then
              echo "âœ… Downloaded Release-iphonesimulator.zip"
              echo "ðŸ“¦ Extracting iOS app..."

              # Extract preserving directory structure (remove -j flag)
              cd ios/build/Build/Products/Release-iphonesimulator/
              unzip -o /tmp/Release-iphonesimulator.zip "MetaMask-QA.app/*"
              cd - > /dev/null

              # Set proper permissions for the app bundle
              chmod -R 755 "ios/build/Build/Products/Release-iphonesimulator/MetaMask-QA.app/" 2>/dev/null || true

            else
              echo "âŒ Failed to download iOS artifacts (Release-iphonesimulator.zip)"
              exit 1
            fi

            # Verify iOS setup
            if [[ -f "ios/build/Build/Products/Release-iphonesimulator/MetaMask-QA.app/Info.plist" ]]; then
              echo "âœ… iOS app ready for E2E tests"
              echo "ðŸ“‹ App bundle contents:"
              ls -la "ios/build/Build/Products/Release-iphonesimulator/MetaMask-QA.app/" | head -10
            else
              echo "âŒ iOS app setup failed - Info.plist not found"
              echo "ðŸ“‹ Directory contents:"
              ls -la "ios/build/Build/Products/Release-iphonesimulator/" || true
              exit 1
            fi

          else
            echo "ðŸ“¥ Downloading Android artifacts..."

            if curl -L --fail -o /tmp/outputs.zip "${base_url}/outputs.zip"; then
              echo "âœ… Downloaded outputs.zip"
              echo "ðŸ“¦ Extracting Android APKs..."

              # Create required directories for both main and test APKs
              mkdir -p android/app/build/outputs/apk/androidTest/qa/release/

              # Extract main APK
              unzip -o -j /tmp/outputs.zip "apk/qa/release/app-qa-release.apk" -d "android/app/build/outputs/apk/qa/release/"

              # Extract test APK (androidTest)
              unzip -o -j /tmp/outputs.zip "apk/androidTest/qa/release/app-qa-release-androidTest.apk" -d "android/app/build/outputs/apk/androidTest/qa/release/"

              # Verify Android setup
              if [[ -f "android/app/build/outputs/apk/qa/release/app-qa-release.apk" ]]; then
                echo "âœ… Android main APK ready for E2E tests"
              else
                echo "âŒ Android main APK setup failed"
                exit 1
              fi

              if [[ -f "android/app/build/outputs/apk/androidTest/qa/release/app-qa-release-androidTest.apk" ]]; then
                echo "âœ… Android test APK ready for E2E tests"
              else
                echo "âŒ Android test APK setup failed"
                exit 1
              fi
            else
              echo "âŒ Failed to download Android artifacts (outputs.zip not available)"
              exit 1
            fi
          fi

      - name: Clean environment before tests (iOS only)
        if: ${{ inputs.platform == 'ios' }}
        run: |
          echo "ðŸ§¹ Cleaning iOS environment before E2E tests..."

          # Clean up lock files (iOS-specific issue)
          find . -name "*.lock" -type f -delete 2>/dev/null || true

          # Clean Detox cache
          yarn detox clean-framework-cache 2>/dev/null || true

          # Reset iOS simulator
          xcrun simctl shutdown all 2>/dev/null || true
          xcrun simctl erase all 2>/dev/null || true

          # Clean any hanging processes
          pkill -f "Metro\|node\|npm" 2>/dev/null || true

          echo "âœ… iOS environment cleaned"

      - name: Run E2E tests with monitoring
        run: |
          platform="${{ inputs.platform }}"
          is_api_specs="${{ inputs.is_api_specs }}"
          test_suite_tag="${{ inputs.test_suite_tag }}"

          echo "ðŸš€ Running ${{ inputs.smoke-category }} tests on $platform"

          # Handle API specs special case (iOS-only)
          if [[ "$is_api_specs" == "true" ]]; then
            if [[ "$platform" != "ios" ]]; then
              echo "â„¹ï¸  API specs are iOS-only, skipping $platform"
              exit 0
            fi
            echo "ðŸ§ª Running API specs tests..."
            yarn test:api-specs --retries 1
            exit 0
          fi

          # Validate required test suite tag
          if [[ -z "$test_suite_tag" ]]; then
            echo "âŒ Error: test_suite_tag is required for non-api-specs tests"
            exit 1
          fi

          export TEST_SUITE_TAG="$test_suite_tag"
          echo "Using TEST_SUITE_TAG: $TEST_SUITE_TAG"

          # Platform-specific preparation
          if [[ "$platform" == "ios" ]]; then
            echo "ðŸ”§ Preparing iOS environment..."
            yarn detox build-framework-cache
            yarn detox reset-lock-file

          else
            echo "ðŸ”§ Preparing Android environment..."
            # Clean up existing emulators (Detox will launch with correct configuration)
            adb devices | grep emulator | cut -f1 | while read line; do
              adb -s "$line" emu kill 2>/dev/null || true
            done
            pkill -f "emulator.*avd" 2>/dev/null || true
            pkill -f "qemu-system" 2>/dev/null || true
            pkill -f "Metro\|node\|npm" 2>/dev/null || true
            sleep 3
            
            echo "âœ… Android environment ready - Detox will launch emulator with 1080x2340 configuration"
          fi

          # Start monitoring just before test execution
          echo "ðŸ” Starting CPU and Memory monitoring for E2E tests..."
          mkdir -p monitoring
          
          # Create monitoring script
          cat > monitoring/resource_monitor.sh << 'EOF'
          #!/bin/bash
          
          MONITOR_LOG="monitoring/resources.log"
          MONITOR_PID_FILE="/tmp/resource_monitor.pid"
          
          # Function to get current resource usage
          log_resources() {
            timestamp=$(date '+%Y-%m-%d %H:%M:%S')
            
            if [[ "$RUNNER_OS" == "macOS" ]]; then
              # macOS resource monitoring
              cpu_usage=$(top -l 1 | grep "CPU usage" | awk '{print $3}' | sed 's/%//')
              memory_info=$(vm_stat | awk '
                /Pages free/ { free = $3 * 4096 / 1024 / 1024 }
                /Pages active/ { active = $3 * 4096 / 1024 / 1024 }
                /Pages inactive/ { inactive = $3 * 4096 / 1024 / 1024 }
                /Pages wired/ { wired = $3 * 4096 / 1024 / 1024 }
                END { 
                  total = free + active + inactive + wired
                  used = total - free
                  printf "%.0f,%.0f,%.1f", total, used, (used/total)*100 
                }
              ')
              echo "$timestamp,macOS,$cpu_usage,$memory_info" >> $MONITOR_LOG
              echo "ðŸ“Š [$timestamp] CPU: ${cpu_usage}% | Memory: $(echo $memory_info | cut -d',' -f3)% used"
              
            else
              # Linux resource monitoring
              cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | sed 's/%us,//')
              memory_info=$(free -m | awk 'NR==2{printf "%d,%d,%.1f", $2,$3,($3/$2)*100}')
              echo "$timestamp,Linux,$cpu_usage,$memory_info" >> $MONITOR_LOG
              echo "ðŸ“Š [$timestamp] CPU: ${cpu_usage}% | Memory: $(echo $memory_info | cut -d',' -f3)% used"
            fi
          }
          
          # Initialize log with headers
          echo "timestamp,os,cpu_percent,memory_total_mb,memory_used_mb,memory_percent" > $MONITOR_LOG
          
          # Background monitoring loop
          while [ -f "/tmp/monitor_active" ]; do
            log_resources
            sleep 10  # Monitor every 10 seconds
          done &
          
          # Save monitoring PID
          echo $! > $MONITOR_PID_FILE
          touch /tmp/monitor_active
          
          echo "âœ… Resource monitoring started (PID: $(cat $MONITOR_PID_FILE))"
          EOF
          
          chmod +x monitoring/resource_monitor.sh
          RUNNER_OS=${{ runner.os }} ./monitoring/resource_monitor.sh

          # Run tests (Detox/Jest handle retries internally)
          echo "ðŸš€ Starting E2E tests..."
          if [[ "$platform" == "ios" ]]; then
            export BITRISE_TRIGGERED_WORKFLOW_ID="ios_workflow"
          else
            export BITRISE_TRIGGERED_WORKFLOW_ID="android_workflow"
          fi
          
          echo "ðŸ’¾ Starting test execution with monitoring..."
          ./scripts/run-e2e-tags.sh
          
          # Verify emulator configuration after Detox launches it (Android only)
          if [[ "$platform" == "android" ]]; then
            echo "ðŸ“± Verifying emulator display configuration after Detox launch..."
            
            # Give emulator a moment to stabilize after Detox startup
            sleep 5
            
            # Check if emulator is running and get display info
            if adb devices | grep -q emulator; then
              width=$(adb shell wm size 2>/dev/null | grep -o '[0-9]*x[0-9]*' | cut -d'x' -f1 || echo "unknown")
              height=$(adb shell wm size 2>/dev/null | grep -o '[0-9]*x[0-9]*' | cut -d'x' -f2 || echo "unknown")
              density=$(adb shell wm density 2>/dev/null | grep -o '[0-9]*' || echo "unknown")
              
              echo "ðŸ“‹ Detox Emulator Display: ${width}x${height}, density: ${density}"
              
              if [[ "$width" == "1080" && "$height" == "2340" && "$density" == "440" ]]; then
                echo "âœ… Emulator running with correct display configuration"
              else
                echo "âš ï¸  Display configuration doesn't match expected values"
                echo "Expected: 1080x2340, density 440"
                echo "Actual: ${width}x${height}, density ${density}"
                echo "This may cause test failures due to element visibility issues"
              fi
            else
              echo "âš ï¸  No emulator detected by ADB after test run"
            fi
          fi
          
          echo "âœ… Test execution completed"
          
          # Stop monitoring immediately after tests
          echo "ðŸ›‘ Stopping resource monitoring..."
          if [ -f /tmp/monitor_active ]; then
            rm /tmp/monitor_active
            echo "Monitor stop signal sent"
          fi
          
          if [ -f /tmp/resource_monitor.pid ]; then
            monitor_pid=$(cat /tmp/resource_monitor.pid)
            kill $monitor_pid 2>/dev/null && echo "Monitor process stopped (PID: $monitor_pid)" || echo "Monitor process already stopped"
            rm /tmp/resource_monitor.pid
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.test-suite-name }}
          path: e2e/reports/
          retention-days: 7
      
      - name: Upload resource monitoring data
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.test-suite-name }}-resources
          path: monitoring/
          retention-days: 7
      
      - name: Upload screenshots
        if: failure() 
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.test-suite-name }}-screenshots
          path: artifacts/
          retention-days: 7
