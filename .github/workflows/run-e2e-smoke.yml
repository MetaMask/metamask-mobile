# This workflow orchestrates mobile E2E smoke tests with separate jobs per category.
# Each category job uses matrix sharding for maximum parallelization.

name: Mobile E2E Smoke Tests

on:
  workflow_call:
  workflow_dispatch:
  pull_request:
    types: [labeled]

env:
  SEGMENT_WRITE_KEY_QA: ${{ secrets.SEGMENT_WRITE_KEY_QA }}
  SEGMENT_PROXY_URL_QA: ${{ secrets.SEGMENT_PROXY_URL_QA }}
  SEGMENT_DELETE_API_SOURCE_ID_QA: ${{ secrets.SEGMENT_DELETE_API_SOURCE_ID_QA }}
  MAIN_IOS_GOOGLE_CLIENT_ID_UAT: ${{ secrets.MAIN_IOS_GOOGLE_CLIENT_ID_UAT }}
  MAIN_IOS_GOOGLE_REDIRECT_URI_UAT: ${{ secrets.MAIN_IOS_GOOGLE_REDIRECT_URI_UAT }}
  MAIN_ANDROID_APPLE_CLIENT_ID_UAT: ${{secrets.MAIN_ANDROID_APPLE_CLIENT_ID_UAT}}
  MAIN_ANDROID_GOOGLE_CLIENT_ID_UAT: ${{secrets.MAIN_ANDROID_GOOGLE_CLIENT_ID_UAT}}
  MAIN_ANDROID_GOOGLE_SERVER_CLIENT_ID_UAT: ${{secrets.MAIN_ANDROID_GOOGLE_SERVER_CLIENT_ID_UAT}}
  SEGMENT_REGULATIONS_ENDPOINT_QA: ${{secrets.SEGMENT_REGULATIONS_ENDPOINT_QA}}
  MM_SENTRY_DSN_TEST: ${{secrets.MM_SENTRY_DSN_TEST}}

jobs:
  smoke-confirmations-ios:
    name: "Confirmations Smoke (iOS)"
    if: github.event.label.name == 'Run E2E Smoke Test'
    uses: ./.github/workflows/run-e2e-mobile.yml
    strategy:
      fail-fast: false
      matrix:
        index: [0, 1, 2, 3]  # 4 shards for 19 files
    with:
      test-suite-name: smoke-confirmations-ios-${{ matrix.index }}
      matrix-index: ${{ matrix.index }}
      matrix-total: ${{ strategy.job-total }}
      platform: ios
      test_suite_tag: "SmokeConfirmations "
      smoke-category: confirmations

  smoke-confirmations-android:
    name: "Confirmations Smoke (Android)"
    if: github.event.label.name == 'Run E2E Smoke Test'
    uses: ./.github/workflows/run-e2e-mobile.yml
    strategy:
      fail-fast: false
      matrix:
        index: [0, 1, 2, 3]  # 4 shards for 19 files
    with:
      test-suite-name: smoke-confirmations-android-${{ matrix.index }}
      matrix-index: ${{ matrix.index }}
      matrix-total: ${{ strategy.job-total }}
      platform: android
      test_suite_tag: "SmokeConfirmations "
      smoke-category: confirmations

  smoke-confirmations-redesigned-ios:
    name: "Confirmations Redesigned Smoke (iOS)"
    if: github.event.label.name == 'Run E2E Smoke Test'
    uses: ./.github/workflows/run-e2e-mobile.yml
    strategy:
      fail-fast: false
      matrix:
        index: [0]  # 1 shard for 2 files
    with:
      test-suite-name: smoke-confirmations-redesigned-ios-${{ matrix.index }}
      matrix-index: ${{ matrix.index }}
      matrix-total: ${{ strategy.job-total }}
      platform: ios
      test_suite_tag: "SmokeConfirmationsRedesigned"
      smoke-category: confirmations-redesigned

  smoke-trade-ios:
    name: "Trade Smoke (iOS)"
    if: github.event.label.name == 'Run E2E Smoke Test'
    uses: ./.github/workflows/run-e2e-mobile.yml
    strategy:
      fail-fast: false
      matrix:
        index: [0, 1, 2]  # 3 shards for 9 files
    with:
      test-suite-name: smoke-trade-ios-${{ matrix.index }}
      matrix-index: ${{ matrix.index }}
      matrix-total: ${{ strategy.job-total }}
      platform: ios
      test_suite_tag: ".*SmokeTrade.*"
      smoke-category: trade

  smoke-trade-android:
    name: "Trade Smoke (Android)"
    if: github.event.label.name == 'Run E2E Smoke Test'
    uses: ./.github/workflows/run-e2e-mobile.yml
    strategy:
      fail-fast: false
      matrix:
        index: [0, 1, 2]  # 3 shards for 9 files
    with:
      test-suite-name: smoke-trade-android-${{ matrix.index }}
      matrix-index: ${{ matrix.index }}
      matrix-total: ${{ strategy.job-total }}
      platform: android
      test_suite_tag: ".*SmokeTrade.*"
      smoke-category: trade

  smoke-wallet-platform-ios:
    name: "Wallet Platform Smoke (iOS)"
    if: github.event.label.name == 'Run E2E Smoke Test'
    uses: ./.github/workflows/run-e2e-mobile.yml
    strategy:
      fail-fast: false
      matrix:
        index: [0, 1, 2]  # 3 shards for 9 files
    with:
      test-suite-name: smoke-wallet-platform-ios-${{ matrix.index }}
      matrix-index: ${{ matrix.index }}
      matrix-total: ${{ strategy.job-total }}
      platform: ios
      test_suite_tag: ".*SmokeWalletPlatform.*"
      smoke-category: wallet-platform

  smoke-wallet-platform-android:
    name: "Wallet Platform Smoke (Android)"
    if: github.event.label.name == 'Run E2E Smoke Test'
    uses: ./.github/workflows/run-e2e-mobile.yml
    strategy:
      fail-fast: false
      matrix:
        index: [0, 1, 2]  # 3 shards for 9 files
    with:
      test-suite-name: smoke-wallet-platform-android-${{ matrix.index }}
      matrix-index: ${{ matrix.index }}
      matrix-total: ${{ strategy.job-total }}
      platform: android
      test_suite_tag: ".*SmokeWalletPlatform.*"
      smoke-category: wallet-platform

  smoke-network-abstraction-ios:
    name: "Network Abstraction Smoke (iOS)"
    if: github.event.label.name == 'Run E2E Smoke Test'
    uses: ./.github/workflows/run-e2e-mobile.yml
    strategy:
      fail-fast: false
      matrix:
        index: [0, 1, 2]  # 3 shards for 15 files
    with:
      test-suite-name: smoke-network-abstraction-ios-${{ matrix.index }}
      matrix-index: ${{ matrix.index }}
      matrix-total: ${{ strategy.job-total }}
      platform: ios
      test_suite_tag: ".*SmokeNetworkAbstraction.*"
      smoke-category: network-abstraction

  smoke-network-abstraction-android:
    name: "Network Abstraction Smoke (Android)"
    if: github.event.label.name == 'Run E2E Smoke Test'
    uses: ./.github/workflows/run-e2e-mobile.yml
    strategy:
      fail-fast: false
      matrix:
        index: [0, 1, 2]  # 3 shards for 15 files
    with:
      test-suite-name: smoke-network-abstraction-android-${{ matrix.index }}
      matrix-index: ${{ matrix.index }}
      matrix-total: ${{ strategy.job-total }}
      platform: android
      test_suite_tag: ".*SmokeNetworkAbstraction.*"
      smoke-category: network-abstraction

  smoke-network-expansion-ios:
    name: "Network Expansion Smoke (iOS)"
    if: github.event.label.name == 'Run E2E Smoke Test'
    uses: ./.github/workflows/run-e2e-mobile.yml
    strategy:
      fail-fast: false
      matrix:
        index: [0, 1, 2]  # 3 shards for 11 files
    with:
      test-suite-name: smoke-network-expansion-ios-${{ matrix.index }}
      matrix-index: ${{ matrix.index }}
      matrix-total: ${{ strategy.job-total }}
      platform: ios
      test_suite_tag: ".*NetworkExpansion.*"
      smoke-category: network-expansion

  smoke-network-expansion-android:
    name: "Network Expansion Smoke (Android)"
    if: github.event.label.name == 'Run E2E Smoke Test'
    uses: ./.github/workflows/run-e2e-mobile.yml
    strategy:
      fail-fast: false
      matrix:
        index: [0, 1, 2]  # 3 shards for 11 files
    with:
      test-suite-name: smoke-network-expansion-android-${{ matrix.index }}
      matrix-index: ${{ matrix.index }}
      matrix-total: ${{ strategy.job-total }}
      platform: android
      test_suite_tag: ".*NetworkExpansion.*"
      smoke-category: network-expansion

  smoke-api-specs-ios:
    name: "API Specs Smoke (iOS only)"
    if: github.event.label.name == 'Run E2E Smoke Test'
    uses: ./.github/workflows/run-e2e-mobile.yml
    strategy:
      fail-fast: false
      matrix:
        index: [0]  # 1 shard for API specs
    with:
      test-suite-name: smoke-api-specs-ios-${{ matrix.index }}
      matrix-index: ${{ matrix.index }}
      matrix-total: ${{ strategy.job-total }}
      platform: ios
      is_api_specs: true
      smoke-category: api-specs

  #test-e2e-mobile-smoke-report:
  #  needs:
  #    - smoke-confirmations-ios
  #    - smoke-confirmations-android
  #    - smoke-confirmations-redesigned-ios
  #    - smoke-trade-ios
  #    - smoke-trade-android
  #    - smoke-wallet-platform-ios
  #    - smoke-wallet-platform-android
  #    - smoke-network-abstraction-ios
  #    - smoke-network-abstraction-android
  #    - smoke-network-expansion-ios
  #    - smoke-network-expansion-android
  #    - smoke-api-specs-ios
  #  runs-on: ubuntu-latest
  #  if: ${{ !cancelled() }}
  #  env:
  #    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #    OWNER: ${{ github.repository_owner }}
  #    REPOSITORY: ${{ github.event.repository.name }}
  #    BRANCH: ${{ github.head_ref || github.ref_name }}
  #  steps:
  #    - name: Checkout and setup environment
  #      uses: MetaMask/action-checkout-and-setup@v1
  #      with:
  #        is-high-risk-environment: false
  #        skip-allow-scripts: true
  #        yarn-custom-url: ${{ vars.YARN_URL }}
#
  #    - name: Download test results
  #      uses: actions/download-artifact@v4
  #      with:
  #        path: .
  #        pattern: smoke-*
  #        merge-multiple: true
#
  #    - name: Aggregate and summarize results
  #      run: |
  #        echo "# Mobile E2E Smoke Test Results (Category + Matrix Sharding)" >> $GITHUB_STEP_SUMMARY
  #        echo "" >> $GITHUB_STEP_SUMMARY
  #        echo "🚀 **Architecture**: Category separation + Matrix sharding (like Firefox E2E)" >> $GITHUB_STEP_SUMMARY
  #        echo "⚡ **Performance**: ~35+ parallel jobs vs previous 12 sequential category jobs" >> $GITHUB_STEP_SUMMARY
  #        echo "" >> $GITHUB_STEP_SUMMARY
  #        
  #        # Matrix job patterns to check
  #        categories=(
  #          "confirmations-ios"
  #          "confirmations-android" 
  #          "confirmations-redesigned-ios"
  #          "trade-ios"
  #          "trade-android"
  #          "wallet-platform-ios"
  #          "wallet-platform-android"
  #          "network-abstraction-ios"
  #          "network-abstraction-android"
  #          "network-expansion-ios"
  #          "network-expansion-android"
  #          "api-specs-ios"
  #        )
  #        
  #        total_jobs=0
  #        passed_jobs=0
  #        failed_jobs=0
  #        
  #        echo "## Results by Category (Matrix Sharded)" >> $GITHUB_STEP_SUMMARY
  #        
  #        for category in "${categories[@]}"; do
  #          echo "### $category" >> $GITHUB_STEP_SUMMARY
  #          
  #          # Count shards for this category
  #          shards_found=0
  #          shards_passed=0
  #          shards_failed=0
  #          
  #          for shard_dir in smoke-${category}-*; do
  #            if [ -d "$shard_dir" ]; then
  #              shards_found=$((shards_found + 1))
  #              total_jobs=$((total_jobs + 1))
  #              
  #              shard_index=$(echo "$shard_dir" | sed "s/smoke-${category}-//")
  #              
  #              if [ -f "$shard_dir/e2e/reports/junit.xml" ]; then
  #                if grep -q 'failures="0"' "$shard_dir/e2e/reports/junit.xml" 2>/dev/null; then
  #                  shards_passed=$((shards_passed + 1))
  #                  passed_jobs=$((passed_jobs + 1))
  #                  echo "  - ✅ **Shard $shard_index**: PASSED" >> $GITHUB_STEP_SUMMARY
  #                else
  #                  shards_failed=$((shards_failed + 1))
  #                  failed_jobs=$((failed_jobs + 1))
  #                  echo "  - ❌ **Shard $shard_index**: FAILED" >> $GITHUB_STEP_SUMMARY
  #                fi
  #              else
  #                shards_failed=$((shards_failed + 1))
  #                failed_jobs=$((failed_jobs + 1))
  #                echo "  - ❌ **Shard $shard_index**: NO RESULTS" >> $GITHUB_STEP_SUMMARY
  #              fi
  #            fi
  #          done
  #          
  #          if [ $shards_found -eq 0 ]; then
  #            echo "  - ❌ **No shards found**" >> $GITHUB_STEP_SUMMARY
  #          else
  #            echo "  - **Total Shards**: $shards_found | **Passed**: $shards_passed | **Failed**: $shards_failed" >> $GITHUB_STEP_SUMMARY
  #          fi
  #          echo "" >> $GITHUB_STEP_SUMMARY
  #        done
  #        
  #        echo "## Overall Summary" >> $GITHUB_STEP_SUMMARY
  #        echo "- **Total Matrix Jobs**: $total_jobs" >> $GITHUB_STEP_SUMMARY
  #        echo "- **Passed**: $passed_jobs" >> $GITHUB_STEP_SUMMARY
  #        echo "- **Failed**: $failed_jobs" >> $GITHUB_STEP_SUMMARY
  #        echo "" >> $GITHUB_STEP_SUMMARY
  #        
  #        echo "### Architecture Benefits" >> $GITHUB_STEP_SUMMARY
  #        echo "- **Category Organization**: Clear separation by smoke test type" >> $GITHUB_STEP_SUMMARY
  #        echo "- **Matrix Sharding**: Multiple parallel jobs per category" >> $GITHUB_STEP_SUMMARY
  #        echo "- **Maximum Parallelization**: ~35+ jobs vs 12 sequential jobs" >> $GITHUB_STEP_SUMMARY
  #        echo "- **Dynamic Discovery**: Test files discovered automatically" >> $GITHUB_STEP_SUMMARY
  #        echo "- **Platform Separation**: Clear iOS/Android job separation" >> $GITHUB_STEP_SUMMARY
  #        echo "" >> $GITHUB_STEP_SUMMARY
  #        
  #        # Set overall result
  #        if [ $failed_jobs -eq 0 ]; then
  #          echo "🎉 All smoke test matrix jobs passed!" >> $GITHUB_STEP_SUMMARY
  #        else
  #          echo "⚠️ Some smoke test matrix jobs failed" >> $GITHUB_STEP_SUMMARY
  #        fi
#
  #    - name: Upload aggregated test results
  #      if: always()
  #      uses: actions/upload-artifact@v4
  #      with:
  #        name: mobile-smoke-test-report
  #        path: test/test-results/
  #        retention-days: 7 
