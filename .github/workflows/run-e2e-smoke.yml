# This workflow orchestrates mobile E2E smoke tests with separate jobs per category.
# Each category job runs all tests for that category on the specified platform.

name: Mobile E2E Smoke Tests

on:
  workflow_call:
  workflow_dispatch:
  pull_request:
    types: [labeled]

jobs:
  smoke-confirmations-ios:
    name: "Confirmations Smoke (iOS)"
    #if: false # github.event.label.name == 'Run E2E Smoke Test'
    uses: ./.github/workflows/run-e2e-mobile.yml
    with:
      test-suite-name: smoke-confirmations-ios
      platform: ios
      test_suite_tag: "SmokeConfirmations "
      smoke-category: confirmations
      use_prebuilt_apps: true
    secrets: inherit

  smoke-confirmations-android:
    name: "Confirmations Smoke (Android)"
    #if: false # github.event.label.name == 'Run E2E Smoke Test'
    uses: ./.github/workflows/run-e2e-mobile.yml
    with:
      test-suite-name: smoke-confirmations-android
      platform: android
      test_suite_tag: "SmokeConfirmations "
      smoke-category: confirmations
      use_prebuilt_apps: true
    secrets: inherit

  smoke-confirmations-redesigned-ios:
    name: "Confirmations Redesigned Smoke (iOS)"
    #if: false # github.event.label.name == 'Run E2E Smoke Test'
    uses: ./.github/workflows/run-e2e-mobile.yml
    with:
      test-suite-name: smoke-confirmations-redesigned-ios
      platform: ios
      test_suite_tag: "SmokeConfirmationsRedesigned"
      smoke-category: confirmations-redesigned
      use_prebuilt_apps: true
    secrets: inherit

  smoke-trade-ios:
    name: "Trade Smoke (iOS)"
    #if: false # github.event.label.name == 'Run E2E Smoke Test'
    uses: ./.github/workflows/run-e2e-mobile.yml
    with:
      test-suite-name: smoke-trade-ios
      platform: ios
      test_suite_tag: ".*SmokeTrade.*"
      smoke-category: trade
      use_prebuilt_apps: true
    secrets: inherit

  smoke-trade-android:
    name: "Trade Smoke (Android)"
    #if: false # github.event.label.name == 'Run E2E Smoke Test'
    uses: ./.github/workflows/run-e2e-mobile.yml
    with:
      test-suite-name: smoke-trade-android
      platform: android
      test_suite_tag: ".*SmokeTrade.*"
      smoke-category: trade
      use_prebuilt_apps: true
    secrets: inherit

  smoke-wallet-platform-ios:
    name: "Wallet Platform Smoke (iOS)"
    #if: false # github.event.label.name == 'Run E2E Smoke Test'
    uses: ./.github/workflows/run-e2e-mobile.yml
    with:
      test-suite-name: smoke-wallet-platform-ios
      platform: ios
      test_suite_tag: ".*SmokeWalletPlatform.*"
      smoke-category: wallet-platform
      use_prebuilt_apps: true
    secrets: inherit

  smoke-wallet-platform-android:
    name: "Wallet Platform Smoke (Android)"
    #if: false # github.event.label.name == 'Run E2E Smoke Test'
    uses: ./.github/workflows/run-e2e-mobile.yml
    with:
      test-suite-name: smoke-wallet-platform-android
      platform: android
      test_suite_tag: ".*SmokeWalletPlatform.*"
      smoke-category: wallet-platform
      use_prebuilt_apps: true
    secrets: inherit

  smoke-identity-ios:
    name: "Identity Smoke (iOS)"
    #if: false # github.event.label.name == 'Run E2E Smoke Test'
    uses: ./.github/workflows/run-e2e-mobile.yml
    with:
      test-suite-name: smoke-identity-ios
      platform: ios
      test_suite_tag: ".*SmokeIdentity.*"
      smoke-category: identity
      use_prebuilt_apps: true
    secrets: inherit

  smoke-identity-android:
    name: "Identity Smoke (Android)"
    #if: false # github.event.label.name == 'Run E2E Smoke Test'
    uses: ./.github/workflows/run-e2e-mobile.yml
    with:
      test-suite-name: smoke-identity-android
      platform: android
      test_suite_tag: ".*SmokeIdentity.*"
      smoke-category: identity
      use_prebuilt_apps: true
    secrets: inherit

  smoke-accounts-ios:
    name: "Accounts Smoke (iOS)"
    #if: false # github.event.label.name == 'Run E2E Smoke Test'
    uses: ./.github/workflows/run-e2e-mobile.yml
    with:
      test-suite-name: smoke-accounts-ios
      platform: ios
      test_suite_tag: ".*SmokeAccounts.*"
      smoke-category: accounts
      use_prebuilt_apps: true
    secrets: inherit

  smoke-accounts-android:
    name: "Accounts Smoke (Android)"
    #if: false # github.event.label.name == 'Run E2E Smoke Test'
    uses: ./.github/workflows/run-e2e-mobile.yml
    with:
      test-suite-name: smoke-accounts-android
      platform: android
      test_suite_tag: ".*SmokeAccounts.*"
      smoke-category: accounts
      use_prebuilt_apps: true
    secrets: inherit

  smoke-network-abstraction-ios:
    name: "Network Abstraction Smoke (iOS)"
    #if: false # github.event.label.name == 'Run E2E Smoke Test'
    uses: ./.github/workflows/run-e2e-mobile.yml
    with:
      test-suite-name: smoke-network-abstraction-ios
      platform: ios
      test_suite_tag: ".*SmokeNetworkAbstraction.*"
      smoke-category: network-abstraction
      use_prebuilt_apps: true
    secrets: inherit

  smoke-network-abstraction-android:
    name: "Network Abstraction Smoke (Android)"
    #if: false # github.event.label.name == 'Run E2E Smoke Test'
    uses: ./.github/workflows/run-e2e-mobile.yml
    with:
      test-suite-name: smoke-network-abstraction-android
      platform: android
      test_suite_tag: ".*SmokeNetworkAbstraction.*"
      smoke-category: network-abstraction
      use_prebuilt_apps: true
    secrets: inherit

  smoke-network-expansion-ios:
    name: "Network Expansion Smoke (iOS)"
    #if: false # github.event.label.name == 'Run E2E Smoke Test'
    uses: ./.github/workflows/run-e2e-mobile.yml
    with:
      test-suite-name: smoke-network-expansion-ios
      platform: ios
      test_suite_tag: ".*NetworkExpansion.*"
      smoke-category: network-expansion
      use_prebuilt_apps: true
    secrets: inherit

  smoke-network-expansion-android:
    name: "Network Expansion Smoke (Android)"
    #if: false # github.event.label.name == 'Run E2E Smoke Test'
    uses: ./.github/workflows/run-e2e-mobile.yml
    with:
      test-suite-name: smoke-network-expansion-android
      platform: android
      test_suite_tag: ".*NetworkExpansion.*"
      smoke-category: network-expansion
      use_prebuilt_apps: true
    secrets: inherit

  smoke-api-specs-ios:
    name: "API Specs Smoke (iOS only)"
    #if: github.event.label.name == 'Run E2E Smoke Test'
    uses: ./.github/workflows/run-e2e-mobile.yml
    with:
      test-suite-name: smoke-api-specs-ios
      platform: ios
      is_api_specs: true
      smoke-category: api-specs
      use_prebuilt_apps: true
    secrets: inherit
  test-e2e-mobile-report:
    name: "ðŸ“Š E2E Test Results Summary"
    needs: [
      smoke-confirmations-ios,
      smoke-confirmations-android,
      smoke-confirmations-redesigned-ios,
      smoke-trade-ios,
      smoke-trade-android,
      smoke-wallet-platform-ios,
      smoke-wallet-platform-android,
      smoke-identity-ios,
      smoke-identity-android,
      smoke-accounts-ios,
      smoke-accounts-android,
      smoke-network-abstraction-ios,
      smoke-network-abstraction-android,
      smoke-network-expansion-ios,
      smoke-network-expansion-android,
      smoke-api-specs-ios
    ]
    runs-on: ubuntu-latest
    if: ${{ !cancelled() }}
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      OWNER: ${{ github.repository_owner }}
      REPOSITORY: ${{ github.event.repository.name }}
      BRANCH: ${{ github.head_ref || github.ref_name }}
      TEST_RUNS_PATH: e2e/test-results/test-runs-mobile.json
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'yarn'

      - name: Install script dependencies
        run: yarn --immutable
        working-directory: '.github/scripts'

      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          path: .
          pattern: smoke-*
          merge-multiple: true

      - name: Create test report
        run: yarn create-e2e-test-report
        working-directory: '.github/scripts'

      - name: Upload test runs
        uses: actions/upload-artifact@v4
        with:
          name: test-e2e-mobile-report
          path: ${{ env.TEST_RUNS_PATH }}
    