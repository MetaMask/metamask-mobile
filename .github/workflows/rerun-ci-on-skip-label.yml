name: Re-run CI on skip-smart-e2e-selection label

on:
  pull_request:
    types: [labeled, unlabeled]

jobs:
  rerun-ci:
    if: github.event.label.name == 'skip-smart-e2e-selection'
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Cancel current CI and restart
        env:
          GH_TOKEN: ${{ github.token }}
          HEAD_REF: ${{ github.head_ref }}
          REPOSITORY: ${{ github.repository }}
        run: |
          echo "üîÑ skip-smart-e2e-selection label changed, restarting CI..."

          # Get the latest CI run for this branch
          RUN_ID=$(gh run list \
            --repo "$REPOSITORY" \
            --branch "$HEAD_REF" \
            --workflow ci.yml \
            --limit 1 \
            --json databaseId,status \
            --jq '.[0].databaseId')

          if [ -z "$RUN_ID" ] || [ "$RUN_ID" == "null" ]; then
            echo "‚ö†Ô∏è No CI run found"
            exit 0
          fi

          echo "üìã Found CI run: $RUN_ID"

          # Cancel if in progress and wait for completion
          RUN_STATUS=$(gh run view "$RUN_ID" --repo "$REPOSITORY" --json status --jq '.status')
          if [ "$RUN_STATUS" == "in_progress" ] || [ "$RUN_STATUS" == "queued" ]; then
            echo "üõë Cancelling in-progress run..."
            gh run cancel "$RUN_ID" --repo "$REPOSITORY" || true

            # Wait for cancellation to complete (poll until status changes)
            echo "‚è≥ Waiting for cancellation to complete..."
            for i in {1..30}; do
              sleep 5
              RUN_STATUS=$(gh run view "$RUN_ID" --repo "$REPOSITORY" --json status --jq '.status')
              echo "   Status: $RUN_STATUS"
              if [ "$RUN_STATUS" == "completed" ]; then
                echo "‚úÖ Run cancelled"
                break
              fi
            done
          fi

          # Re-run the workflow (works for both forks and main repo)
          echo "üöÄ Re-running CI..."
          gh run rerun "$RUN_ID" --repo "$REPOSITORY"

          echo "‚úÖ CI restart triggered"
