name: Re-run CI on skip-smart-e2e-selection label

on:
  pull_request:
    types: [labeled, unlabeled]

jobs:
  rerun-ci:
    if: github.event.label.name == 'skip-smart-e2e-selection'
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Cancel current CI and start fresh
        env:
          GH_TOKEN: ${{ github.token }}
          HEAD_REF: ${{ github.head_ref }}
          REPOSITORY: ${{ github.repository }}
        run: |
          echo "ðŸ”„ skip-smart-e2e-selection label added, restarting CI..."

          # Cancel any in-progress CI runs for this branch
          gh run list \
            --repo "$REPOSITORY" \
            --branch "$HEAD_REF" \
            --workflow ci.yml \
            --status in_progress \
            --json databaseId \
            --jq '.[].databaseId' | while read -r RUN_ID; do
              if [ -n "$RUN_ID" ]; then
                echo "ðŸ›‘ Cancelling run: $RUN_ID"
                gh run cancel "$RUN_ID" --repo "$REPOSITORY" || true
              fi
            done

          # Trigger a fresh CI run on the PR branch
          echo "ðŸš€ Starting fresh CI run..."
          gh workflow run ci.yml --repo "$REPOSITORY" --ref "$HEAD_REF"

          echo "âœ… CI restart triggered"
