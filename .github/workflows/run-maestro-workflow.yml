name: Run Maestro Workflow

on:
  workflow_call:
    inputs:
      test-suite-name:
        description: 'Name of the test suite'
        required: true
        type: string
      test-file:
        description: 'Path to Maestro test file'
        required: true
        type: string
      build_type:
        description: 'Build type (main or flask)'
        required: false
        type: string
        default: 'main'
      metamask_environment:
        description: 'MetaMask environment'
        required: false
        type: string
        default: 'e2e'
      branch:
        description: 'Branch to checkout'
        required: false
        type: string
        default: 'main'

jobs:
  test-maestro:
    name: ${{ inputs.test-suite-name }}
    runs-on: ghcr.io/cirruslabs/ubuntu-runner-amd64:24.04-lg
    timeout-minutes: 30

    env:
      METAMASK_ENVIRONMENT: ${{ inputs.metamask_environment }}
      METAMASK_BUILD_TYPE: ${{ inputs.build_type }}
      PLATFORM: android

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}

      - name: Install Android System Images
        run: |
          echo "üì± Installing Android system images..."
          "$ANDROID_SDK_ROOT"/cmdline-tools/latest/bin/sdkmanager "system-images;android-34;google_apis;x86_64"
          echo "‚úÖ System images installed"

      - name: Set up E2E environment
        uses: MetaMask/github-tools/.github/actions/setup-e2e-env@v1
        with:
          platform: android
          setup-simulator: true
          android-avd-name: emulator
          configure-keystores: false

      - name: Determine Android target paths
        id: determine-target-paths
        run: |
          if [[ "${{ inputs.build_type }}" == "flask" ]]; then
            echo "apk-target-path=android/app/build/outputs/apk/flask/release" >> "$GITHUB_OUTPUT"
            echo "artifact_name=app-flask-release" >> "$GITHUB_OUTPUT"
          elif [[ "${{ inputs.build_type }}" == "main" ]]; then
            echo "apk-target-path=android/app/build/outputs/apk/prod/release" >> "$GITHUB_OUTPUT"
            echo "artifact_name=app-prod-release" >> "$GITHUB_OUTPUT"
          else
            echo "‚ùå Error: build_type ${{ inputs.build_type }} is not valid"
            exit 1
          fi

      - name: Setup Android artifacts directories
        run: |
          echo "üèó Setting up Android artifacts directories..."
          mkdir -p ${{ steps.determine-target-paths.outputs.apk-target-path }}

      - name: Download Android APK
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.build_type }}-${{ inputs.metamask_environment }}-release.apk
          path: artifacts/

      - name: Move APK to expected location
        run: |
          cp artifacts/${{ steps.determine-target-paths.outputs.artifact_name }}.apk \
             ${{ steps.determine-target-paths.outputs.apk-target-path }}/${{ steps.determine-target-paths.outputs.artifact_name }}.apk
          echo "‚úÖ APK ready at: ${{ steps.determine-target-paths.outputs.apk-target-path }}/${{ steps.determine-target-paths.outputs.artifact_name }}.apk"

      - name: Install Maestro CLI
        run: |
          echo "üì¶ Installing Maestro CLI..."
          curl -fsSL "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> "$GITHUB_PATH"

      - name: Verify Maestro installation
        run: |
          export PATH="$HOME/.maestro/bin:$PATH"
          echo "‚úÖ Maestro version:"
          maestro --version
          echo "‚úÖ Java version:"
          java -version

      - name: Start Android Emulator
        run: |
          echo "üöÄ Starting Android emulator..."
          # List available AVDs
          echo "Available AVDs:"
          "$ANDROID_SDK_ROOT"/emulator/emulator -list-avds
          
          # Start emulator in background with no-window for CI
          nohup "$ANDROID_SDK_ROOT"/emulator/emulator -avd emulator -no-window -no-audio -no-boot-anim -gpu swiftshader_indirect &
          
          echo "‚úÖ Emulator starting in background..."

      - name: Wait for emulator to be ready
        run: |
          echo "‚è≥ Waiting for emulator to boot..."
          # Wait for device to come online
          adb wait-for-device
          
          # Wait for boot to complete (with timeout)
          TIMEOUT=300
          ELAPSED=0
          echo "Waiting for sys.boot_completed..."
          while [ -z "$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r')" ]; do
            if [ $ELAPSED -ge $TIMEOUT ]; then
              echo "‚ùå Emulator boot timed out after ${TIMEOUT}s"
              adb devices
              exit 1
            fi
            sleep 5
            ELAPSED=$((ELAPSED + 5))
            echo "  Still waiting... ${ELAPSED}s"
          done
          
          echo "‚úÖ Emulator ready after ${ELAPSED}s"
          adb devices

      - name: Install APK on emulator
        run: |
          echo "üì≤ Installing APK on emulator..."
          adb install ${{ steps.determine-target-paths.outputs.apk-target-path }}/${{ steps.determine-target-paths.outputs.artifact_name }}.apk
          echo "‚úÖ APK installed"

      - name: Setup recordings directory
        run: mkdir -p maestro-recordings

      - name: Run Maestro Test with Recording
        id: maestro-test
        continue-on-error: true
        run: |
          echo "üé≠ Running Maestro test with recording: ${{ inputs.test-file }}"
          echo "üìç Branch: ${{ inputs.branch }}"
          
          # Use maestro record --local to capture video locally (no external API)
          # Syntax: maestro record --local <flowFile> [<outputFile>]
          # Recording will be saved even if test fails
          if maestro record --local ${{ inputs.test-file }} maestro-recordings/test-recording.mp4; then
            echo "‚úÖ Maestro test passed"
            echo "TEST_RESULT=success" >> "$GITHUB_ENV"
          else
            echo "‚ùå Maestro test failed"
            echo "TEST_RESULT=failure" >> "$GITHUB_ENV"
          fi

      - name: Zip recordings on failure
        if: env.TEST_RESULT == 'failure'
        run: |
          echo "üì¶ Zipping test recordings..."
          cd maestro-recordings
          zip -r ../maestro-recordings.zip . || echo "No recordings to zip"
          cd ..
          ls -la maestro-recordings.zip || echo "Zip file not created"

      - name: Upload recording on failure
        if: env.TEST_RESULT == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: maestro-${{ inputs.test-suite-name }}-recording
          path: maestro-recordings.zip
          retention-days: 7
          if-no-files-found: warn

      - name: Upload screenshots on failure
        if: env.TEST_RESULT == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: maestro-${{ inputs.test-suite-name }}-screenshots
          path: ~/.maestro/tests/**/screenshot_*.png
          retention-days: 7
          if-no-files-found: warn

      - name: Fail job if test failed
        if: env.TEST_RESULT == 'failure'
        run: |
          echo "‚ùå Maestro test failed - see uploaded recording and screenshots for details"
          exit 1
