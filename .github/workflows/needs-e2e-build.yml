# This workflow is used to detect changes in the Android and iOS projects.
# It can be used to determine if the build should be triggered for the Android and iOS projects.
# Outputs:
# - android_changed: Whether Android-impacting files changed
# - ios_changed: Whether iOS-impacting files changed
# - any_changed: Whether either platform requires a build

name: Detect Mobile Build Changes

on:
  workflow_call:
    outputs:
      android_changed:
        description: 'Whether Android-impacting files changed'
        value: ${{ jobs.needs-e2e-build.outputs.android }}
      ios_changed:
        description: 'Whether iOS-impacting files changed'
        value: ${{ jobs.needs-e2e-build.outputs.ios }}
      builds:
        description: 'Whether any builds will happen'
        value: ${{ jobs.needs-e2e-build.outputs.builds }}
      changed_files:
        description: 'Changed files'
        value: ${{ jobs.needs-e2e-build.outputs.changed_files }}

jobs:
  needs-e2e-build:
    name: Check if builds will happen
    runs-on: gha-mm-scale-set-ubuntu-22.04-amd64-small
    outputs:
      android: ${{ steps.set-outputs.outputs.android_final }}
      ios: ${{ steps.set-outputs.outputs.ios_final }}
      builds: ${{ steps.set-outputs.outputs.builds }}
      changed_files: ${{ steps.set-outputs.outputs.changed_files }}
    env:
      # For a `pull_request` event, the head commit hash is `github.event.pull_request.head.sha`.
      # For a `push` event, the head commit hash is `github.sha`.
      HEAD_COMMIT_HASH: ${{ github.event.pull_request.head.sha || github.sha }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Specifying `ref` ensures that the head commit is checked out directly.
          ref: ${{ env.HEAD_COMMIT_HASH }}

      - name: Check skip commit tag
        id: skip-tag
        run: |
          echo "SKIP=false" >> "$GITHUB_OUTPUT"
          if [[ "${{ github.event_name }}" == "pull_request" ]] || [[ "${{ github.event_name }}" == "merge_group" ]]; then
            if git show --format='%B' --no-patch "${HEAD_COMMIT_HASH}" | grep --fixed-strings --quiet '[skip-e2e]'; then
              echo "SKIP=true" >> "$GITHUB_OUTPUT"
              echo "-> SKIP=true due to [skip-e2e] tag in last commit message"
            fi
          fi

      - name: Check skip label
        id: skip-label
        if: github.event_name == 'pull_request'
        run: |
          echo "SKIP=false" >> "$GITHUB_OUTPUT"
          if gh pr view ${{ github.event.pull_request.number }} --json labels --jq '.labels[].name' | grep -qx "skip-e2e"; then
            echo "SKIP=true" >> "$GITHUB_OUTPUT"
            echo "-> SKIP=true due to 'skip-e2e' label on PR"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Paths filter (Android/iOS impact)
        id: filter
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36
        with:
          filters: |
            android:
              - 'android/**'                       # All Android project files

            ios:
              - 'ios/**'                           # All iOS project files

            shared:
              - 'package.json'                     # If native deps change
              - 'metro.config.js'                  # Metro bundler affects both
              - 'tsconfig.json'                    # TypeScript config affects both
              - 'babel.config.js'                  # Transpilation affects both
              - 'yarn.lock'                        # Dependency changes affect both
              - 'app/**'                           # Shared app files
              - 'e2e/**'                           # E2E test files (separate from mobile builds)
              - 'sentry*.properties*'              # Sentry configs
              - 'wdio/**'                          # WebDriver test files
              - 'wdio.conf.js'                     # WebDriver config
              - 'appwright/**'                     # Appwright test files


            ignore:
              - '**/*.md'                          # Documentation files
              - 'docs/**'                          # Documentation directory
              - '**/*.yml'                         # Workflow files  
              - '.github/**'                       # GitHub workflow changes
              - 'LICENSE'                          # License file
              - 'README.md'                        # Main README
              - 'RELEASE.MD'                       # Release notes
              - 'CHANGELOG.md'                     # Changelog
              - 'attribution.txt'                  # Attribution file
              - '*.svg'                            # SVG files (like architecture.svg)
              - '*.png'                            # PNG files (like logo.png, image.png)
              - 'codecov.yml'                      # Code coverage config
              - 'crowdin.yml'                      # Translation config
              - 'bitrise.yml'                      # CI config (non-GitHub)
              - 'sonar-project.properties'         # SonarQube config
              - 'scripts/**'                       # Build/utility scripts
              - 'patches/**'                       # Dependency patches
              - 'ppom/**'                          # PPOM sub-project

            catch_all:
              - '**/*'                             # Matches everything for conservative fallback
          list-files: 'shell' # Output lists for comparison

      - name: Set final outputs
        id: set-outputs
        run: |
          # Compute outputs using Node script
          GITHUB_EVENT_NAME="${{ github.event_name }}" \
          SHOULD_SKIP_E2E= "${{ steps.skip-tag.outputs.SKIP }}" == "true" || "${{ steps.skip-label.outputs.SKIP }}" == "true"  \
          ANDROID="${{ steps.filter.outputs.android }}" \
          IOS="${{ steps.filter.outputs.ios }}" \
          SHARED="${{ steps.filter.outputs.shared }}" \
          IGNORE_FILES="${{ steps.filter.outputs.ignore_files }}" \
          CATCH_ALL_FILES="${{ steps.filter.outputs.catch_all_files }}" \
          node .github/scripts/compute-mobile-builds.mjs
