name: TEMP Android Flask E2E Smoke Tests (Repacking)

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - '**'  # Run on all branches when pushed

permissions:
  contents: read
  id-token: write

jobs:
  needs_e2e_build:
    name: 'Detect Mobile Build Changes'
    uses: ./.github/workflows/needs-e2e-build.yml

  build-main-android-apks:
    name: 'Build Main Android APKs'
    # if: ${{ needs.needs_e2e_build.outputs.android_changed == 'true' }}
    # needs: [needs_e2e_build]
    uses: ./.github/workflows/build-android-e2e.yml
    with:
      build_type: 'main'
      metamask_environment: 'e2e'
      keystore_target: 'qa'
    secrets: inherit

  repack-android-flask-apps:
    name: 'Repack Android Flask Apps'
    #if: ${{ needs.needs_e2e_build.outputs.android_changed == 'true' }}
    runs-on: ghcr.io/cirruslabs/ubuntu-runner-amd64:24.04-lg
    permissions:
      contents: read
      id-token: write
    needs: [build-main-android-apks]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'yarn'

      - name: Install dependencies
        uses: nick-fields/retry@ce71cc2ab81d554ebbe88c79ab5975992d79ba08 #v3.0.2
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 30
          command: yarn install --immutable

      - name: Setup project
        run: yarn setup:github-ci --no-build-ios

      - name: Configure Flask UAT Keystore
        uses: MetaMask/github-tools/.github/actions/configure-keystore@0259e8a920318b02a8860e178d79796eaa08de02
        with:
          aws-role-to-assume: ${{ secrets.METAMASK_MOBILE_BUILDER_SIGNER_QA }}
          aws-region: us-east-2
          platform: android
          target: flask
        env:
          ANDROID_KEYSTORE_PATH: android/keystores/flask-uat.keystore

      - name: Download Main APK artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
          pattern: main-e2e-release*.apk

      - name: Setup Main APK artifacts
        run: |
          mkdir -p android/app/build/outputs/apk/prod/release/
          mkdir -p android/app/build/outputs/apk/androidTest/prod/release/
          # Artifacts are downloaded as folders, each containing the APK file
          # Copy main APK from artifact folder to expected location
          cp artifacts/main-e2e-release.apk/app-prod-release.apk android/app/build/outputs/apk/prod/release/app-prod-release.apk
          # Copy main test APK from artifact folder to expected location
          cp artifacts/main-e2e-release-androidTest.apk/app-prod-release-androidTest.apk android/app/build/outputs/apk/androidTest/prod/release/app-prod-release-androidTest.apk

      - name: Repack Main to Flask
        run: node scripts/repack.js
        env:
          PLATFORM: android
          METAMASK_BUILD_TYPE: flask
          SOURCE_APK: android/app/build/outputs/apk/prod/release/app-prod-release.apk
          CI: 'true'
          # ANDROID_KEYSTORE_PATH is set here (configure-keystore action writes keystore to android/keystores/flask-uat.keystore)
          # Keystore credentials (BITRISEIO_ANDROID_FLASK_UAT_KEYSTORE_*) are automatically exported by configure-keystore action
          ANDROID_KEYSTORE_PATH: android/keystores/flask-uat.keystore

        # test
      - name: Ensure Flask APK is in expected location
        run: |
          # The repack tool may write to working directory instead of outputPath
          # Check if final APK exists, if not, look in working directory
          if [ ! -f android/app/build/outputs/apk/flask/release/app-flask-release.apk ]; then
            echo "Final APK not found, checking working directory..."
            if [ -f android/app/build/repack-working-main/resigned.apk ]; then
              echo "Found signed APK in working directory, copying to final location"
              mkdir -p android/app/build/outputs/apk/flask/release/
              cp android/app/build/repack-working-main/resigned.apk android/app/build/outputs/apk/flask/release/app-flask-release.apk
            else
              echo "❌ Flask APK not found in expected location or working directory"
              echo "Working directory contents:"
              ls -la android/app/build/repack-working-main/ || echo "Working directory does not exist"
              exit 1
            fi
          else
            echo "✅ Flask APK found at expected location"
          fi

      - name: Install Android Build Tools
        run: |
          ANDROID_SDK_ROOT=/opt/android-sdk
          echo "ANDROID_SDK_ROOT=${ANDROID_SDK_ROOT}" >> "$GITHUB_ENV"
          echo "ANDROID_HOME=${ANDROID_SDK_ROOT}" >> "$GITHUB_ENV"
          "${ANDROID_SDK_ROOT}"/cmdline-tools/latest/bin/sdkmanager "build-tools;34.0.0"
          echo "${ANDROID_SDK_ROOT}/build-tools/34.0.0" >> "$GITHUB_PATH"

      - name: Re-sign Flask Test APK
        run: |
          # Create destination directory for Test APK
          mkdir -p android/app/build/outputs/apk/androidTest/flask/release/
          # Re-sign test APK with Flask UAT keystore to match the repacked Flask APK
          # Android requires test APK and main APK to have matching signatures
          echo "Re-signing test APK with Flask UAT keystore..."
          apksigner sign \
            --ks android/keystores/flask-uat.keystore \
            --ks-pass "pass:${BITRISEIO_ANDROID_FLASK_UAT_KEYSTORE_PASSWORD}" \
            --ks-key-alias "${BITRISEIO_ANDROID_FLASK_UAT_KEYSTORE_ALIAS}" \
            --key-pass "pass:${BITRISEIO_ANDROID_FLASK_UAT_KEYSTORE_PRIVATE_KEY_PASSWORD}" \
            --out android/app/build/outputs/apk/androidTest/flask/release/app-flask-release-androidTest.apk \
            android/app/build/outputs/apk/androidTest/prod/release/app-prod-release-androidTest.apk
          echo "Test APK re-signed with Flask UAT keystore"
        env:
          # Keystore credentials are automatically exported by configure-keystore action
          ANDROID_KEYSTORE_PATH: android/keystores/flask-uat.keystore

      - name: Upload Flask APK
        uses: actions/upload-artifact@v4
        with:
          name: flask-e2e-release.apk
          path: android/app/build/outputs/apk/flask/release/app-flask-release.apk
          retention-days: 1

      - name: Upload Flask Test APK
        uses: actions/upload-artifact@v4
        with:
          name: flask-e2e-release-androidTest.apk
          path: android/app/build/outputs/apk/androidTest/flask/release/app-flask-release-androidTest.apk
          retention-days: 1

  flask-android-smoke:
    strategy:
      matrix:
        split: [1, 2, 3]
      fail-fast: false
    needs: [repack-android-flask-apps]
    # if: ${{ needs.needs_e2e_build.outputs.android_changed == 'true' }}
    uses: ./.github/workflows/run-e2e-workflow.yml
    with:
      test-suite-name: flask-android-smoke-${{ matrix.split }}
      platform: android
      test_suite_tag: 'FlaskBuildTests'
      split_number: ${{ matrix.split }}
      total_splits: 3
      # changed_files: ${{ needs.needs_e2e_build.outputs.changed_files }}
      changed_files: ''
      build_type: 'flask'
      metamask_environment: 'e2e'
    secrets: inherit

  report-android-smoke-tests:
    name: Report Android Smoke Tests
    runs-on: ubuntu-latest
    if: ${{ !cancelled() }}
    needs:
      - flask-android-smoke
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Download shards test artifacts (XMLs + Screenshots)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          path: all-test-artifacts/
          pattern: 'test-e2e-*-android-*'

      - name: Post Test Report
        uses: dorny/test-reporter@dc3a92680fcc15842eef52e8c4606ea7ce6bd3f3
        with:
          name: 'TEMP Android Flask E2E Smoke Test Results (Repacking)'
          path: 'all-test-artifacts/**/junit.xml'
          reporter: 'jest-junit'
          fail-on-error: false
          list-suites: 'failed'
          list-tests: 'failed'

      - name: Upload all test artifacts (XMLs + Screenshots)
        uses: actions/upload-artifact@v4
        with:
          name: temp-e2e-smoke-android-flask-all-test-artifacts
          path: all-test-artifacts/

