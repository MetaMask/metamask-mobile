#!/usr/bin/env node
/**
 * Maps GitHub Secrets to environment variables based on builds.yml config.
 * Runs at workflow runtime (during the "Set secrets" step).
 *
 * Reads CONFIG_SECRETS (the build's secrets map from builds.yml) and injects
 * each secret value into GITHUB_ENV so subsequent steps (e.g. build.sh) see
 * them. The workflow must pass secrets into this step's env (the list is
 * generated by scripts/generate-build-workflow-secrets-env.js from builds.yml).
 *
 * CONFIG_SECRETS format: { "ENV_VAR_NAME": "GITHUB_SECRET_NAME", ... }
 */

const fs = require('fs');

const secretsMapping = JSON.parse(process.env.CONFIG_SECRETS || '{}');
const githubEnvPath = process.env.GITHUB_ENV;

function appendToGithubEnv(name, value) {
  if (!githubEnvPath) {
    process.env[name] = value;
    return;
  }
  // Values with newlines must use delimiter format (GitHub Actions requirement)
  if (value.includes('\n') || value.includes('\r')) {
    const delimiter = `ENV_${name}_${Math.random().toString(36).slice(2, 10)}`;
    fs.appendFileSync(githubEnvPath, `${name}<<${delimiter}\n`);
    fs.appendFileSync(githubEnvPath, `${value}\n`);
    fs.appendFileSync(githubEnvPath, `${delimiter}\n`);
  } else {
    // Single-line: escape % and newlines per GitHub docs
    const escaped = String(value)
      .replace(/%/g, '%25')
      .replace(/\r/g, '%0D')
      .replace(/\n/g, '%0A');
    fs.appendFileSync(githubEnvPath, `${name}=${escaped}\n`);
  }
}

Object.entries(secretsMapping).forEach(([envVar, secretName]) => {
  const value = process.env[secretName];
  if (value) {
    process.env[envVar] = value;
    appendToGithubEnv(envVar, value);
    console.log(`✓ ${envVar}`);
  } else {
    console.warn(`⚠ ${secretName} not found (for ${envVar})`);
  }
});
