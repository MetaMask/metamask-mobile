# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

default_platform(:ios)

platform :ios do
  # Upload existing IPA to TestFlight (for use in CI/CD)
  desc "Upload existing IPA to TestFlight for MetaMask main app"
  lane :upload_to_testflight_only do |options|
    ipa_path = options[:ipa_path]
    groups = ['MetaMask Fastlane Test']
    notify_external_testers = options[:notify_external_testers] || false
    skip_waiting_for_build_processing = options[:skip_waiting_for_build_processing] || false
    
    if ipa_path.nil? || ipa_path.empty?
      UI.user_error!("You must provide an ipa_path using ipa_path: '/path/to/app.ipa'")
    end
    
    unless File.exist?(ipa_path)
      UI.user_error!("IPA file not found at: #{ipa_path}")
    end
    
    UI.message("Uploading IPA to TestFlight: #{ipa_path}")
    
    # Get API key from environment variables
    api_key_issuer_id = ENV['APP_STORE_CONNECT_API_KEY_ISSUER_ID']
    api_key_key_id = ENV['APP_STORE_CONNECT_API_KEY_KEY_ID']
    api_key_key_filepath = ENV['APP_STORE_CONNECT_API_KEY_KEY_FILEPATH']
    
    if api_key_issuer_id.nil? || api_key_key_id.nil? || api_key_key_filepath.nil?
      UI.user_error!("App Store Connect API Key environment variables are not set")
    end
    
    unless File.exist?(api_key_key_filepath)
      UI.user_error!("API key file not found at: #{api_key_key_filepath}")
    end
    
    # Upload to TestFlight with explicit API key
    upload_to_testflight(
      api_key: {
        key_id: api_key_key_id,
        issuer_id: api_key_issuer_id,
        key_filepath: api_key_key_filepath
      },
      ipa: ipa_path,
      skip_waiting_for_build_processing: skip_waiting_for_build_processing,
      skip_submission: false,
      distribute_external: true,
      groups: groups,
      notify_external_testers: notify_external_testers,
      changelog: options[:changelog] || "New build uploaded via Fastlane from Bitrise"
    )
  end
end

